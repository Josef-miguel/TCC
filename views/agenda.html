{% extends "base.html" %}

{% block content %}
<div class="container">
  <div class="agenda-header">
    <h1>Minha Agenda</h1>
  </div>

  <!-- Calendário -->
  <div id="calendar" class="calendar-card"></div>

  <!-- Lista de eventos -->
  <div class="events-section">
    <h2>Meus Eventos</h2>
    <div id="agendaPosts" class="event-list"></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const calendarEl = document.getElementById("calendar");

  // busca os eventos do backend
  const res = await fetch("/agenda_api_all");
  const data = await res.json();

  const events = data.success
    ? data.events.map(ev => ({
        id: ev.id,
        title: ev.title,
        start: ev.exit_date,
        end: ev.return_date || ev.exit_date
      }))
    : [];

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: "dayGridMonth",
    locale: "pt-br",
    height: "auto",
    events: events,
    headerToolbar: {
      left: "prev",
      center: "title",
      right: "next"
    },
    dateClick: function(info) {
      fetch(`/agenda_api/${info.dateStr}`)
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById("agendaPosts");
          container.innerHTML = "";
          if (data.success && data.events.length > 0) {
            data.events.forEach(ev => {
              const div = document.createElement("div");
              div.classList.add("event-card");
              div.innerHTML = `
                <h3>✈️ ${ev.title}</h3>
                <p>${ev.desc || ""}</p>
                <p><strong>Saída:</strong> ${ev.exit_date}</p>
                <p><strong>Retorno:</strong> ${ev.return_date || "-"}</p>
              `;
              container.appendChild(div);
            });
          } else {
            container.innerHTML = "<p class='no-event'>Nenhum evento nesse dia.</p>";
          }
        });
    }
  });

  calendar.render();
});
</script>
{% endblock %}
