{% extends "base.html" %}

{% block content %}
<div class="event-detail-container">
  <!-- Header com navegação -->
  <div class="detail-header">
    <div class="header-content">
      <button class="back-button" onclick="history.back()">
        <ion-icon name="arrow-back"></ion-icon>
        <span>Voltar</span>
      </button>
      <h1 class="page-title">Detalhes da Viagem</h1>
    </div>
  </div>

  <!-- Hero Section -->
  <div class="hero-section">
    {% if event.images and event.images|length > 0 %}
    <div class="hero-image-container">
      <img src="{{ event.images[0] }}" alt="Imagem da viagem" class="hero-image">
      <div class="image-overlay">
        <div class="hero-content">
          <h1 class="event-title">
            {% if event.title %}
              {{ event.title }}
            {% else %}
              Viagem sem título
            {% endif %}
          </h1>
          <div class="hero-stats">
            <div class="stat-item">
              <ion-icon name="eye-outline"></ion-icon>
              <span>{{ event.numAcess or 0 }} visualizações</span>
            </div>
            <div class="stat-item">
              <ion-icon name="flame-outline"></ion-icon>
              <span>{{ event.ratingCount or 0 }} avaliações</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <div class="hero-no-image">
      <div class="hero-content">
        <h1 class="event-title">
          {% if event.title %}
            {{ event.title }}
          {% else %}
            Viagem sem título
          {% endif %}
        </h1>
        <div class="hero-stats">
          <div class="stat-item">
            <ion-icon name="eye-outline"></ion-icon>
            <span>{{ event.numAcess or 0 }} visualizações</span>
          </div>
          <div class="stat-item">
            <ion-icon name="flame-outline"></ion-icon>
            <span>{{ event.ratingCount or 0 }} avaliações</span>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Conteúdo Principal -->
  <div class="main-content">
    <div class="content-grid">
      <!-- Coluna Principal -->
      <div class="main-column">
        <!-- Informações do Organizador -->
        <div class="organizer-card">
          <div class="organizer-header">
            <div class="organizer-avatar">
              {% if event.organizer and event.organizer.profile_picture %}
                <img src="{{ event.organizer.profile_picture }}" alt="Avatar do organizador">
              {% else %}
                <div class="avatar-placeholder">
                  {% if event.organizer and event.organizer.name %}
                    {{ event.organizer.name[0].upper() }}
                  {% else %}
                    O
                  {% endif %}
                </div>
              {% endif %}
            </div>
            <div class="organizer-info">
              <h3 class="organizer-name">
                {% if event.organizer and event.organizer.name %}
                  {{ event.organizer.name }}
                {% else %}
                  Organizador
                {% endif %}
                {% if event.organizer and event.organizer.is_organizer %}
                  <ion-icon name="checkmark-circle" class="verified-badge"></ion-icon>
                {% endif %}
              </h3>
              <p class="organizer-role">Organizador da viagem</p>
            </div>
            <button class="organizer-menu">
              <ion-icon name="ellipsis-horizontal"></ion-icon>
            </button>
          </div>
        </div>

        <!-- Descrição -->
        {% if event.desc %}
        <div class="description-card">
          <h3 class="card-title">
            <ion-icon name="document-text-outline"></ion-icon>
            Sobre esta viagem
          </h3>
          <div class="description-content">
            <p>{{ event.desc }}</p>
          </div>
        </div>
        {% endif %}

        <!-- Tags -->
        {% if event.tags %}
        <div class="tags-card">
          <h3 class="card-title">
            <ion-icon name="pricetag-outline"></ion-icon>
            Tags
          </h3>
          <div class="tags-container">
            {% for tag in event.tags %}
              <span class="tag">#{{ tag }}</span>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Mapa da Rota -->
        {% if event.route %}
        <div class="map-card">
          <h3 class="card-title">
            <ion-icon name="map-outline"></ion-icon>
            Rota da Viagem
          </h3>
          <div class="map-container">
            <div class="map" id="route-map" data-route='{{ event.route | tojson | safe }}'></div>
          </div>
          {% if event.route.start and event.route.end %}
          <div class="route-info">
            <div class="route-point">
              <div class="point-icon start">
                <ion-icon name="play-circle"></ion-icon>
              </div>
              <div class="point-info">
                <span class="point-label">Saída</span>
                <span class="point-name">{{ event.route.display_start or 'Ponto de partida' }}</span>
              </div>
            </div>
            <div class="route-point">
              <div class="point-icon end">
                <ion-icon name="stop-circle"></ion-icon>
              </div>
              <div class="point-info">
                <span class="point-label">Destino</span>
                <span class="point-name">{{ event.route.display_end or 'Destino' }}</span>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
        {% endif %}

        <!-- Comentários -->
        <div class="comments-card">
          <div class="comments-header">
            <h3 class="card-title">
              <ion-icon name="chatbubbles-outline"></ion-icon>
              Avaliações e Comentários
            </h3>
            <button class="toggle-comments-btn" data-event-id="{{ event.id }}">
              <ion-icon name="chevron-up-outline"></ion-icon>
            </button>
          </div>
          
          <div class="comments-section" id="comments-section-{{ event.id }}">
            <!-- Formulário de Comentário -->
            {% if user %}
            <div class="comment-form">
              <div class="comment-input-group">
                <textarea 
                  class="comment-input" 
                  id="comment-input-{{ event.id }}"
                  placeholder="Escreva sua avaliação..."
                  rows="3"
                  maxlength="500"></textarea>
                <button class="comment-submit-btn" data-event-id="{{ event.id }}">
                  <ion-icon name="send"></ion-icon>
                </button>
              </div>
            </div>
            {% endif %}

            <!-- Lista de Comentários -->
            <div class="comments-list" id="comments-list-{{ event.id }}">
              <div class="comments-loading" id="comments-loading-{{ event.id }}">
                <div class="loading-spinner"></div>
                <span>Carregando avaliações...</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Coluna Lateral -->
      <div class="sidebar-column">
        <!-- Informações da Viagem -->
        <div class="trip-info-card">
          <h3 class="card-title">
            <ion-icon name="information-circle-outline"></ion-icon>
            Informações da Viagem
          </h3>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-icon">
                <ion-icon name="calendar-outline"></ion-icon>
              </div>
              <div class="info-content">
                <span class="info-label">Data de Saída</span>
                <span class="info-value">
                  {% if event.exit_date %}
                    {{ event.exit_date.strftime('%d/%m/%Y') }}
                  {% else %}
                    Não definida
                  {% endif %}
                </span>
              </div>
            </div>

            <div class="info-item">
              <div class="info-icon">
                <ion-icon name="return-up-back-outline"></ion-icon>
              </div>
              <div class="info-content">
                <span class="info-label">Data de Retorno</span>
                <span class="info-value">
                  {% if event.return_date %}
                    {{ event.return_date.strftime('%d/%m/%Y') }}
                  {% else %}
                    Não definida
                  {% endif %}
                </span>
              </div>
            </div>

            <div class="info-item">
              <div class="info-icon">
                <ion-icon name="cash-outline"></ion-icon>
              </div>
              <div class="info-content">
                <span class="info-label">Preço</span>
                <span class="info-value">
                  {% if event.price %}
                    R$ {{ event.price }}
                  {% else %}
                    Não informado
                  {% endif %}
                </span>
              </div>
            </div>

            <div class="info-item">
              <div class="info-icon">
                <ion-icon name="people-outline"></ion-icon>
              </div>
              <div class="info-content">
                <span class="info-label">Vagas Disponíveis</span>
                <span class="info-value">
                  {% if event.numSlots %}
                    {{ event.numSlots }} vagas
                  {% else %}
                    Não informadas
                  {% endif %}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Botões de Ação -->
        <div class="action-buttons-card">
          <div class="action-buttons">
            <button class="action-btn favorite-btn" data-event-id="{{ event.id }}" id="favorite-btn-{{ event.id }}">
              <ion-icon name="heart-outline" id="heart-icon-{{ event.id }}"></ion-icon>
              <span id="favorite-text-{{ event.id }}">Favoritar</span>
            </button>
            
            <button class="action-btn share-btn" onclick="shareEvent()">
              <ion-icon name="share-outline"></ion-icon>
              <span>Compartilhar</span>
            </button>
          </div>

          <!-- Botão de Participação - VERSÃO CORRIGIDA E SIMPLIFICADA -->
          {% if user %}
            <!-- DEBUG: User joinedEvents = {{ user.joinedEvents }}, Event ID = {{ event.id }} -->
            
            {% if user.joinedEvents and event.id in user.joinedEvents %}
              <!-- USUÁRIO JÁ PARTICIPANDO - MOSTRAR BOTÃO FALAR COM GRUPO -->
              <div class="participation-status">
                <div class="status-icon">
                  <ion-icon name="checkmark-circle"></ion-icon>
                </div>
                <div class="status-content">
                  <h4>Você está participando!</h4>
                  <p>Você já está inscrito nesta viagem</p>
                </div>
                <form action="{{ url_for('chat_group') }}" method="post">
                  <input type="hidden" name="org_uid" value="{{ event.id }}">
                  <button type="submit" class="btn btn-secondary btn-full-width">
                    <ion-icon name="chatbubbles-outline"></ion-icon>
                    Falar com o grupo
                  </button>
                </form>
              </div>
            {% else %}
              <!-- USUÁRIO NÃO PARTICIPANDO - MOSTRAR BOTÃO PARTICIPAR -->
              <form action="{{ url_for('joinEvent') }}" method="post" class="join-form">
                <button type="submit" class="btn btn-primary btn-full-width">
                  <ion-icon name="add-circle-outline"></ion-icon>
                  Participar da viagem
                </button>
                <input type="hidden" name="event_id" value="{{ event.id }}">
              </form>
            {% endif %}
          {% else %}
            <!-- USUÁRIO NÃO LOGADO -->
            <div class="login-prompt">
              <div class="login-icon">
                <ion-icon name="lock-closed-outline"></ion-icon>
              </div>
              <div class="login-content">
                <h4>Login necessário</h4>
                <p>Para participar desta viagem, você precisa estar logado.</p>
                <a href="{{ url_for('login') }}" class="btn btn-primary btn-full-width">Fazer Login</a>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ==================== SISTEMA DE COMENTÁRIOS ====================
  
  const commentsState = {};
  
  function initializeComments() {
    document.querySelectorAll('.toggle-comments-btn').forEach(btn => {
      const eventId = btn.dataset.eventId;
      
      btn.addEventListener('click', () => toggleComments(eventId));
      
      // Carregar comentários automaticamente
      loadComments(eventId);
    });
    
    document.querySelectorAll('.comment-submit-btn').forEach(btn => {
      const eventId = btn.dataset.eventId;
      btn.addEventListener('click', () => submitComment(eventId));
    });
  }
  
  function toggleComments(eventId) {
    const section = document.getElementById(`comments-section-${eventId}`);
    const btn = document.querySelector(`[data-event-id="${eventId}"].toggle-comments-btn`);
    const icon = btn.querySelector('ion-icon');
    
    if (section.style.display === 'none') {
      section.style.display = 'block';
      icon.name = 'chevron-up-outline';
    } else {
      section.style.display = 'none';
      icon.name = 'chevron-down-outline';
    }
  }
  
  async function loadComments(eventId) {
    const loadingElement = document.getElementById(`comments-loading-${eventId}`);
    const listElement = document.getElementById(`comments-list-${eventId}`);
    
    loadingElement.style.display = 'flex';
    
    try {
      const response = await fetch(`/api/comments/${eventId}?page=1&limit=10`);
      const data = await response.json();
      
      if (data.success) {
        listElement.innerHTML = '';
        loadingElement.style.display = 'none';
        
        if (data.comments.length === 0) {
          listElement.innerHTML = `
            <div class="comments-empty">
              <ion-icon name="chatbubble-outline"></ion-icon>
              <h4>Nenhuma avaliação ainda</h4>
              <p>Seja o primeiro a avaliar esta viagem!</p>
            </div>
          `;
        } else {
          data.comments.forEach(comment => {
            listElement.appendChild(createCommentElement(comment));
          });
        }
      }
    } catch (error) {
      console.error('Erro ao carregar comentários:', error);
      loadingElement.style.display = 'none';
    }
  }
  
  function createCommentElement(comment) {
    const div = document.createElement('div');
    div.className = 'comment-item';
    
    const initial = comment.author_name.charAt(0).toUpperCase();
    
    div.innerHTML = `
      <div class="comment-header">
        <div class="comment-avatar">${initial}</div>
        <div class="comment-author-info">
          <div class="comment-author-name">${comment.author_name}</div>
          <div class="comment-date">${comment.data_criacao_formatted}</div>
        </div>
      </div>
      <p class="comment-text">${comment.texto}</p>
    `;
    
    return div;
  }
  
  async function submitComment(eventId) {
    const input = document.getElementById(`comment-input-${eventId}`);
    const submitBtn = document.querySelector(`[data-event-id="${eventId}"].comment-submit-btn`);
    const texto = input.value.trim();
    
    if (!texto) return;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<ion-icon name="hourglass"></ion-icon>';
    
    try {
      const response = await fetch('/api/comments', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          event_id: eventId,
          texto: texto,
          nota: 5
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        input.value = '';
        
        const listElement = document.getElementById(`comments-list-${eventId}`);
        const emptyState = listElement.querySelector('.comments-empty');
        if (emptyState) {
          emptyState.remove();
        }
        
        const newCommentElement = createCommentElement(data.comment);
        listElement.insertBefore(newCommentElement, listElement.firstChild);
      }
    } catch (error) {
      console.error('Erro ao enviar comentário:', error);
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<ion-icon name="send"></ion-icon>';
    }
  }
  
  initializeComments();

  // ==================== SISTEMA DE FAVORITOS ====================
  
  const favoritesState = {};
  
  function initializeFavorites() {
    document.querySelectorAll('.favorite-btn').forEach(btn => {
      const eventId = btn.dataset.eventId;
      
      btn.addEventListener('click', () => toggleFavorite(eventId));
      loadFavoriteStatus(eventId);
      
      favoritesState[eventId] = {
        is_favorited: false,
        loading: false
      };
    });
  }
  
  async function loadFavoriteStatus(eventId) {
    try {
      const response = await fetch(`/api/favorites/${eventId}/status`);
      const data = await response.json();
      
      if (data.success) {
        updateFavoriteUI(eventId, data.is_favorited);
        favoritesState[eventId].is_favorited = data.is_favorited;
      }
    } catch (error) {
      console.error('Erro ao carregar status do favorito:', error);
    }
  }
  
  async function toggleFavorite(eventId) {
    if (favoritesState[eventId].loading) return;
    
    favoritesState[eventId].loading = true;
    
    const btn = document.getElementById(`favorite-btn-${eventId}`);
    const icon = document.getElementById(`heart-icon-${eventId}`);
    
    btn.disabled = true;
    
    try {
      const response = await fetch(`/api/favorites/${eventId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      });
      
      const data = await response.json();
      
      if (data.success) {
        favoritesState[eventId].is_favorited = data.is_favorited;
        updateFavoriteUI(eventId, data.is_favorited);
      }
    } catch (error) {
      console.error('Erro ao alterar favorito:', error);
    } finally {
      btn.disabled = false;
      favoritesState[eventId].loading = false;
    }
  }
  
  function updateFavoriteUI(eventId, isFavorited) {
    const icon = document.getElementById(`heart-icon-${eventId}`);
    const text = document.getElementById(`favorite-text-${eventId}`);
    const btn = document.getElementById(`favorite-btn-${eventId}`);
    
    if (isFavorited) {
      icon.name = 'heart';
      text.textContent = 'Favoritado';
      btn.classList.add('favorited');
    } else {
      icon.name = 'heart-outline';
      text.textContent = 'Favoritar';
      btn.classList.remove('favorited');
    }
  }
  
  initializeFavorites();

  // ==================== MAPA ====================
  
  const mapDiv = document.getElementById('route-map');
  if (mapDiv) {
    let route;
    try {
      route = JSON.parse(mapDiv.dataset.route);
    } catch (e) {
      console.warn("Route inválida:", mapDiv.dataset.route);
      return;
    }

    if (!route || !route.start || !route.end) {
      console.warn("Evento sem rota válida");
      return;
    }

    const centerLat = (route.start.latitude + route.end.latitude) / 2;
    const centerLng = (route.start.longitude + route.end.longitude) / 2;

    const map = L.map('route-map').setView([centerLat, centerLng], 8);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
    }).addTo(map);

    L.marker([route.start.latitude, route.start.longitude])
      .addTo(map)
      .bindPopup(route.display_start || "Saída");

    L.marker([route.end.latitude, route.end.longitude])
      .addTo(map)
      .bindPopup(route.display_end || "Chegada");

    L.Routing.control({
      waypoints: [
        L.latLng(route.start.latitude, route.start.longitude),
        L.latLng(route.end.latitude, route.end.longitude)
      ],
      lineOptions: { styles: [{ color: 'blue', opacity: 0.7, weight: 4 }] },
      addWaypoints: false,
      draggableWaypoints: false,
      routeWhileDragging: false,
      fitSelectedRoutes: true,
      showAlternatives: false
    }).addTo(map);

    setTimeout(() => map.invalidateSize(), 500);
  }
});

function shareEvent() {
  if (navigator.share) {
    navigator.share({
      title: document.querySelector('.event-title').textContent,
      text: 'Confira esta viagem incrível!',
      url: window.location.href
    });
  } else {
    navigator.clipboard.writeText(window.location.href).then(() => {
      alert('Link copiado para a área de transferência!');
    });
  }
}
</script>
{% endblock %}