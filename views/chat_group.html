{% extends "base.html" %}
{% block content %}
<div class="chat-interface group-chat">
    <!-- Header do Chat em Grupo -->
    <div class="chat-header-bar group-header">
        <button class="back-btn" onclick="history.back()">
            <ion-icon name="arrow-back-outline"></ion-icon>
        </button>
        <div class="chat-group-info">
            <div class="chat-group-avatar">
                <ion-icon name="people"></ion-icon>
            </div>
            <div class="chat-group-details">
                <h3 class="chat-group-name">{{ group_name or 'Grupo de Viagem' }}</h3>
                <span class="chat-group-members">{{ group_members_count or 0 }} membros</span>
            </div>
        </div>
        <div class="chat-actions">
            <button class="chat-action-btn" onclick="showGroupInfo()">
                <ion-icon name="information-circle-outline"></ion-icon>
            </button>
            <button class="chat-action-btn" onclick="showGroupMembers()">
                <ion-icon name="people-outline"></ion-icon>
            </button>
        </div>
    </div>

    <!-- Área de Mensagens -->
    <div class="chat-messages-container">
        <div id="chat-box" class="chat-messages group-messages"></div>
        
        <!-- Indicador de digitação -->
        <div class="typing-indicator" id="typing-indicator" style="display: none;">
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <span class="typing-text">Alguém está digitando...</span>
        </div>
    </div>

    <!-- Input de Mensagem -->
    <div class="chat-input-container">
        <div class="chat-input-wrapper">
            <button class="attachment-btn">
                <ion-icon name="attach-outline"></ion-icon>
            </button>
            <div class="message-input-wrapper">
                <input type="text" id="message" placeholder="Digite uma mensagem..." autocomplete="off">
                <button class="emoji-btn">
                    <ion-icon name="happy-outline"></ion-icon>
                </button>
            </div>
            <button type="submit" id="send-btn" class="send-btn">
                <ion-icon name="send"></ion-icon>
            </button>
        </div>
    </div>
</div>

<!-- Modal de Informações do Grupo -->
<div class="group-info-modal" id="group-info-modal" style="display: none;">
    <div class="modal-overlay" onclick="closeGroupInfo()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Informações do Grupo</h3>
            <button class="modal-close" onclick="closeGroupInfo()">
                <ion-icon name="close-outline"></ion-icon>
            </button>
        </div>
        <div class="modal-body">
            <div class="group-info-section">
                <h4>Nome do Grupo</h4>
                <p>{{ group_name or 'Grupo de Viagem' }}</p>
            </div>
            <div class="group-info-section">
                <h4>Membros</h4>
                <p>{{ group_members_count or 0 }} membros no total</p>
                <div class="members-list">
                    {% if participants %}
                        {% for participant in participants %}
                        <div class="member-item">
                            <div class="member-avatar">
                                <ion-icon name="person"></ion-icon>
                            </div>
                            <span class="member-name">{{ participant.name }}</span>
                            <span class="member-role">{{ 'Você' if participant.is_current_user else 'Membro' }}</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="member-item">
                            <div class="member-avatar">
                                <ion-icon name="person"></ion-icon>
                            </div>
                            <span class="member-name">Você</span>
                            <span class="member-role">Admin</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
  const eventId = "{{ event_id }}";
  const chatBox = document.getElementById("chat-box");
  const input = document.getElementById("message");
  const sendBtn = document.getElementById("send-btn");

  // Event listener para o botão de envio
  sendBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    await sendMessage();
  });

  // Event listener para Enter no input
  input.addEventListener("keypress", async (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      await sendMessage();
    }
  });

  async function sendMessage() {
    const text = input.value.trim();
    if (!text) return;

    const res = await fetch("/send_group_message", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ event_id: eventId, text })
    });

    const result = await res.json();
    if (result.success) {
      input.value = "";
      loadMessages(); 
    } else {
      alert(result.message || "Erro ao enviar");
    }
  }

  async function loadMessages() {
    const res = await fetch(`/get_group_messages?event_id=${eventId}`);
    const data = await res.json();
    chatBox.innerHTML = "";

    data.messages.forEach(msg => {
      const messageEl = createGroupMessageElement(msg);
      chatBox.appendChild(messageEl);
    });

    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function createGroupMessageElement(message) {
    const msgEl = document.createElement('div');
    msgEl.className = 'group-message';
    msgEl.setAttribute('data-message-id', message.id);
    
    const senderName = message.name || "Usuário";
    
    // Processar timestamp corretamente
    let timestamp, messageTime;
    if (message.timestamp) {
      if (message.timestamp._seconds) {
        // Firestore Timestamp format
        messageTime = new Date(message.timestamp._seconds * 1000);
      } else if (typeof message.timestamp === 'string') {
        messageTime = new Date(message.timestamp);
      } else if (message.timestamp instanceof Date) {
        messageTime = message.timestamp;
      } else {
        messageTime = new Date();
      }
    } else {
      messageTime = new Date();
    }
    
    // Verificar se a data é válida
    if (isNaN(messageTime.getTime())) {
      messageTime = new Date();
    }
    
    timestamp = messageTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    const isOwnMessage = message.uid_sender === "{{ g.user['uid'] }}";
    const isEdited = message.edited || false;
    const isOldMessage = (Date.now() - messageTime.getTime()) > 3600000; // 1 hora em ms
    
    const editDeleteButtons = isOwnMessage && !isOldMessage ? `
      <div class="message-actions">
        <button class="edit-btn" onclick="editGroupMessage('${message.id}', '${message.text.replace(/'/g, "\\'")}')">
          <ion-icon name="create-outline"></ion-icon>
        </button>
        <button class="delete-btn" onclick="deleteGroupMessage('${message.id}')">
          <ion-icon name="trash-outline"></ion-icon>
        </button>
      </div>
    ` : '';
    
    msgEl.innerHTML = `
      <div class="group-message-content">
        <div class="group-message-avatar">
          <ion-icon name="person"></ion-icon>
        </div>
        <div class="group-message-bubble">
          <div class="group-message-header">
            <span class="group-sender-name">${senderName}</span>
            <span class="group-message-time">${timestamp}</span>
          </div>
          <p class="group-message-text">${message.text}</p>
          ${isEdited ? '<div class="message-footer"><span class="edited-indicator">(editado)</span></div>' : ''}
        </div>
        ${editDeleteButtons}
      </div>
    `;
    
    return msgEl;
  }

  // Funções para o modal
  function showGroupInfo() {
    document.getElementById('group-info-modal').style.display = 'flex';
  }

  function showGroupMembers() {
    showGroupInfo(); // Por enquanto, mostra as mesmas informações
  }

  function closeGroupInfo() {
    document.getElementById('group-info-modal').style.display = 'none';
  }

  // Função para editar mensagem no grupo
  async function editGroupMessage(messageId, currentText) {
    const newText = prompt('Editar mensagem:', currentText);
    if (newText === null || newText.trim() === currentText.trim()) return;
    
    if (newText.trim().length === 0) {
      alert('A mensagem não pode estar vazia');
      return;
    }
    
    if (newText.length > 1000) {
      alert('A mensagem é muito longa (máximo 1000 caracteres)');
      return;
    }
    
    try {
      const requestData = {
        text: newText.trim(),
        chat_type: 'group',
        chat_id: eventId
      };
      
      console.log('Enviando dados para edição (grupo):', requestData);
      console.log('Message ID:', messageId);
      
      const res = await fetch(`/api/messages/${messageId}/edit`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(requestData)
      });
      
      console.log('Resposta do servidor (grupo):', res.status, res.statusText);
      
      const result = await res.json();
      console.log('Resultado da edição (grupo):', result);
      
      if (result.success) {
        loadMessages(); // Recarregar mensagens
      } else {
        alert(result.message || 'Erro ao editar mensagem');
      }
    } catch (error) {
      console.error('Erro ao editar mensagem:', error);
      alert('Erro ao editar mensagem');
    }
  }

  // Função para excluir mensagem no grupo
  async function deleteGroupMessage(messageId) {
    if (!confirm('Tem certeza que deseja excluir esta mensagem?')) return;
    
    try {
      const requestData = {
        chat_type: 'group',
        chat_id: eventId
      };
      
      console.log('Enviando dados para exclusão (grupo):', requestData);
      console.log('Message ID:', messageId);
      
      const res = await fetch(`/api/messages/${messageId}/delete`, {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(requestData)
      });
      
      console.log('Resposta do servidor (grupo):', res.status, res.statusText);
      
      const result = await res.json();
      console.log('Resultado da exclusão (grupo):', result);
      
      if (result.success) {
        loadMessages(); // Recarregar mensagens
      } else {
        alert(result.message || 'Erro ao excluir mensagem');
      }
    } catch (error) {
      console.error('Erro ao excluir mensagem:', error);
      alert('Erro ao excluir mensagem');
    }
  }

  // Auto-refresh das mensagens
  setInterval(loadMessages, 3000); 
  loadMessages();
</script>
{% endblock %}
