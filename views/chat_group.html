{% extends "base.html" %}
{% block content %}
<h2>Chat do Evento</h2>

<div id="chat-box" style="border:1px solid #ccc; height:300px; overflow-y:scroll; padding:8px;"></div>

<form id="chat-form">
  <input type="text" id="message" placeholder="Digite uma mensagem..." autocomplete="off">
  <button type="submit">Enviar</button>
</form>

<script>
  const eventId = "{{ event_id }}";
  const chatBox = document.getElementById("chat-box");
  const form = document.getElementById("chat-form");
  const input = document.getElementById("message");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;

    const res = await fetch("/send_group_message", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ event_id: eventId, text })
    });

    const result = await res.json();
    if (result.success) {
      input.value = "";
      loadMessages(); // recarrega após envio
    } else {
      alert(result.message || "Erro ao enviar");
    }
  });

  async function loadMessages() {
    const res = await fetch(`/get_messages?event_id=${eventId}`);
    const data = await res.json();
    chatBox.innerHTML = "";

    data.messages.forEach(msg => {
      const p = document.createElement("p");
      p.innerHTML = `<strong>${msg.name || "Usuário"}:</strong> ${msg.text}`;
      chatBox.appendChild(p);
    });

    chatBox.scrollTop = chatBox.scrollHeight;
  }

  setInterval(loadMessages, 3000); // atualiza a cada 3s
  loadMessages();
</script>
{% endblock %}
