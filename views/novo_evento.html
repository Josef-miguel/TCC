{% extends "base.html" %}

{% block content %}
<div class="container">
  <div class="card">
    <h3>Cadastrar Novo Evento</h3>
    <form id="eventoForm">
      <div class="form-group">
        <label for="title">Título</label>
        <input type="text" id="title" name="title" required class="form-control">
      </div>

      <div class="form-group">
        <label for="image_urls">URLs das Imagens</label>
        <textarea id="image_urls" name="image_urls" class="form-control" rows="3" placeholder="Cole uma URL por linha"></textarea>
      </div>

      <div id="imagePreview" style="margin-top:12px; display:flex; flex-wrap:wrap; gap:12px;"></div>

      <div class="form-group">
        <label for="desc">Descrição</label>
        <textarea id="desc" name="desc" required class="form-control"></textarea>
      </div>

      <div class="form-group">
        <label for="price">Preço</label>
        <input type="number" id="price" name="price" required class="form-control">
      </div>

      <div class="form-group">
        <label for="numSlots">Número de vagas</label>
        <input type="number" id="numSlots" name="numSlots" required class="form-control">
      </div>

      <div class="form-group">
        <label for="exit_date">Data de saída</label>
        <input type="datetime-local" id="exit_date" name="exit_date" required class="form-control">
      </div>

      <div class="form-group">
        <label for="return_date">Data de retorno</label>
        <input type="datetime-local" id="return_date" name="return_date" required class="form-control">
      </div>

      <div class="form-group">
        <label for="type">Tipo</label>
        <select id="type" name="type" class="form-control">
          <option value="1">Passeio</option>
          <option value="2">Excursão</option>
          <option value="3">Viagem longa</option>
        </select>
      </div>

      <!-- Campo hidden para armazenar a rota -->
      <input type="hidden" id="route" name="route">

      <div class="form-group" style="margin-top:16px;">
        <label>Selecione a rota no mapa</label>
        <div id="map" style="height:400px; width:100%; border-radius:12px; margin-top:8px;"></div>
      </div>

      <button type="submit" class="btn btn-primary">Cadastrar</button>
      <div id="formAlert" style="margin-top:12px"></div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet CSS/JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("eventoForm");
  const alertDiv = document.getElementById("formAlert");
  const routeInput = document.getElementById("route");

  // Inicializa o mapa
  const map = L.map('map').setView([-22.9068, -43.1729], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
  }).addTo(map);

  let waypoints = [];
  let routingControl = null;

  // Clique no mapa adiciona waypoints
  map.on("click", (e) => {
    if (waypoints.length >= 2) {
      waypoints = []; // reseta se já tiver 2 pontos
    }
    waypoints.push(L.latLng(e.latlng.lat, e.latlng.lng));

    if (routingControl) {
      map.removeControl(routingControl);
    }

    if (waypoints.length === 2) {
      routingControl = L.Routing.control({
        waypoints: waypoints,
        lineOptions: { styles: [{ color: 'blue', opacity: 0.7, weight: 5 }] },
        routeWhileDragging: true,
        draggableWaypoints: true,
        addWaypoints: false
      }).addTo(map);

      saveRoute();
    }
  });

  async function getAddress(lat, lng) {
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
    const resp = await fetch(url, { headers: { 'User-Agent': 'JSG/1.0' } });
    if (!resp.ok) return `${lat}, ${lng}`;
    const data = await resp.json();
    return data.display_name || `${lat}, ${lng}`;
  }


  async function saveRoute() {
    if (waypoints.length < 2) return;

    const startAddr = await getAddress(waypoints[0].lat, waypoints[0].lng);
    const endAddr   = await getAddress(waypoints[1].lat, waypoints[1].lng);

    const routeData = {
      display_start: startAddr,
      start: { latitude: waypoints[0].lat, longitude: waypoints[0].lng },
      display_end: endAddr,
      end: { latitude: waypoints[1].lat, longitude: waypoints[1].lng }
    };

    routeInput.value = JSON.stringify(routeData);
  }

  // Submit do form
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const data = {
      title: form.title.value,
      desc: form.desc.value,
      price: form.price.value,
      numSlots: form.numSlots.value,
      exit_date: form.exit_date.value,
      return_date: form.return_date.value,
      type: form.type.value,
      image_urls: form.image_urls.value
        .split("\n")
        .map(u => u.trim())
        .filter(u => u),
      route: routeInput.value ? JSON.parse(routeInput.value) : null
    };

    try {
      const resp = await fetch("/new_event", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const text = await resp.text();
      let result;
      try { result = JSON.parse(text); } catch (_) { result = null; console.log("Resposta bruta:", text); }

      if (resp.ok && result && result.success) {
        alertDiv.innerHTML = `<div style="color:green">${result.message}</div>`;
        form.reset();
        routeInput.value = "";
        waypoints = [];
        if (routingControl) {
          map.removeControl(routingControl);
          routingControl = null;
        }
      } else {
        const msg = (result && result.message) ? result.message : `Erro: ${resp.status}`;
        alertDiv.innerHTML = `<div style="color:red">${msg}</div>`;
      }
    } catch (err) {
      console.error(err);
      alertDiv.innerHTML = `<div style="color:red">Erro na requisição</div>`;
    }
  });
});
</script>


{% endblock %}
