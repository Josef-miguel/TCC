{% extends "base.html" %}

{% block content %}
<div class="container">
  <div class="card">
    <h3>Cadastrar Novo Evento</h3>
    <form id="eventoForm">
      <div class="form-group">
        <label for="title">Título</label>
        <input type="text" id="title" name="title" required class="form-control">
      </div>

      <div class="form-group">
        <label for="image_urls">URLs das Imagens</label>
        <textarea id="image_urls" name="image_urls" class="form-control" rows="3" placeholder="Cole uma URL por linha"></textarea>
      </div>

      <div id="imagePreview" style="margin-top:12px; display:flex; flex-wrap:wrap; gap:12px;"></div>

      <div class="form-group">
        <label for="desc">Descrição</label>
        <textarea id="desc" name="desc" required class="form-control"></textarea>
      </div>

      <div class="form-group">
        <label for="price">Preço</label>
        <input type="number" id="price" name="price" required class="form-control">
      </div>

      <div class="form-group">
        <label for="numSlots">Número de vagas</label>
        <input type="number" id="numSlots" name="numSlots" required class="form-control">
      </div>

      <div class="form-group">
        <label for="exit_date">Data de saída</label>
        <input type="datetime-local" id="exit_date" name="exit_date" required class="form-control">
      </div>

      <div class="form-group">
        <label for="return_date">Data de retorno</label>
        <input type="datetime-local" id="return_date" name="return_date" required class="form-control">
      </div>

      <div class="form-group">
        <label for="type">Tipo</label>
        <select id="type" name="type" class="form-control">
          <option value="1">Viagem</option>
          <option value="2">Excursão</option>
          <option value="3">Show</option>
        </select>
      </div>

      <div class="form-group">
        <label for="tags">Tags</label>
        <div class="tags-container">
          <div class="tags-selector">
            <div class="selected-tags" id="selectedTags"></div>
            <button type="button" class="tags-dropdown-btn" id="tagsDropdownBtn">
              <span>Selecione as tags</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div class="tags-dropdown" id="tagsDropdown">
              <div class="tags-search">
                <input type="text" id="tagsSearch" placeholder="Buscar tags..." />
              </div>
              <div class="tags-options" id="tagsOptions">
                <label class="tag-option">
                  <input type="checkbox" value="relaxante">
                  <span class="tag-label">Relaxante</span>
                </label>
                <label class="tag-option">
                  <input type="checkbox" value="aventura">
                  <span class="tag-label">Aventura</span>
                </label>
                <label class="tag-option">
                  <input type="checkbox" value="acao">
                  <span class="tag-label">Ação</span>
                </label>
                <label class="tag-option">
                  <input type="checkbox" value="cultural">
                  <span class="tag-label">Cultural</span>
                </label>
                <label class="tag-option">
                  <input type="checkbox" value="gastronomia">
                  <span class="tag-label">Gastronomia</span>
                </label>
                <label class="tag-option">
                  <input type="checkbox" value="natureza">
                  <span class="tag-label">Natureza</span>
                </label>
                <label class="tag-option">
                  <input type="checkbox" value="esportes">
                  <span class="tag-label">Esportes</span>
                </label>
                <label class="tag-option">
                  <input type="checkbox" value="praia">
                  <span class="tag-label">Praia</span>
                </label>
                <label class="tag-option">
                  <input type="checkbox" value="montanha">
                  <span class="tag-label">Montanha</span>
                </label>
                <label class="tag-option">
                  <input type="checkbox" value="cidade">
                  <span class="tag-label">Cidade</span>
                </label>
                <label class="tag-option">
                  <input type="checkbox" value="romantico">
                  <span class="tag-label">Romântico</span>
                </label>
                <label class="tag-option">
                  <input type="checkbox" value="familia">
                  <span class="tag-label">Família</span>
                </label>
              </div>
            </div>
          </div>
        </div>
        <input type="hidden" id="tags" name="tags">
      </div>

      <!-- Campo hidden para armazenar a rota -->
      <input type="hidden" id="route" name="route">

      <div class="form-group" style="margin-top:16px;">
        <label>Selecione a rota no mapa</label>
        <div class="map-search-container">
          <div class="map-search-bar">
            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21 21L16.65 16.65M19 11.5C19 15.6421 15.6421 19 11.5 19C7.35786 19 4 15.6421 4 11.5C4 7.35786 7.35786 4 11.5 4C15.6421 4 19 7.35786 19 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <input type="text" id="mapSearch" placeholder="Buscar localização..." />
            <button type="button" id="searchLocationBtn">Buscar</button>
          </div>
          <div id="map" style="height:400px; width:100%; border-radius:12px; margin-top:8px;"></div>
        </div>
      </div>

      <button type="submit" class="btn btn-primary">Cadastrar</button>
      <div id="formAlert" style="margin-top:12px"></div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet CSS/JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("eventoForm");
  const alertDiv = document.getElementById("formAlert");
  const routeInput = document.getElementById("route");

  // Sistema de Tags
  const tagsDropdownBtn = document.getElementById("tagsDropdownBtn");
  const tagsDropdown = document.getElementById("tagsDropdown");
  const tagsSearch = document.getElementById("tagsSearch");
  const tagsOptions = document.getElementById("tagsOptions");
  const selectedTags = document.getElementById("selectedTags");
  const tagsHiddenInput = document.getElementById("tags");
  let selectedTagsList = [];

  // Inicializa o mapa
  const map = L.map('map').setView([-22.9068, -43.1729], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
  }).addTo(map);

  let waypoints = [];
  let routingControl = null;

  // Sistema de Tags - Event Listeners
  tagsDropdownBtn.addEventListener('click', () => {
    tagsDropdown.classList.toggle('active');
  });

  // Fechar dropdown ao clicar fora
  document.addEventListener('click', (e) => {
    if (!tagsDropdownBtn.contains(e.target) && !tagsDropdown.contains(e.target)) {
      tagsDropdown.classList.remove('active');
    }
  });

  // Busca de tags
  tagsSearch.addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const tagOptions = tagsOptions.querySelectorAll('.tag-option');
    
    tagOptions.forEach(option => {
      const label = option.querySelector('.tag-label').textContent.toLowerCase();
      if (label.includes(searchTerm)) {
        option.style.display = 'block';
      } else {
        option.style.display = 'none';
      }
    });
  });

  // Seleção de tags
  tagsOptions.addEventListener('change', (e) => {
    if (e.target.type === 'checkbox') {
      const value = e.target.value;
      const label = e.target.nextElementSibling.textContent;
      
      if (e.target.checked) {
        if (!selectedTagsList.includes(value)) {
          selectedTagsList.push(value);
        }
      } else {
        selectedTagsList = selectedTagsList.filter(tag => tag !== value);
      }
      
      updateSelectedTagsDisplay();
      updateTagsHiddenInput();
    }
  });

  function updateSelectedTagsDisplay() {
    selectedTags.innerHTML = '';
    selectedTagsList.forEach(tag => {
      const tagElement = document.createElement('span');
      tagElement.className = 'selected-tag';
      tagElement.innerHTML = `
        ${getTagLabel(tag)}
        <button type="button" class="remove-tag" data-tag="${tag}">×</button>
      `;
      selectedTags.appendChild(tagElement);
    });

    // Adicionar evento de remoção
    selectedTags.querySelectorAll('.remove-tag').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const tagToRemove = e.target.dataset.tag;
        selectedTagsList = selectedTagsList.filter(tag => tag !== tagToRemove);
        
        // Desmarcar checkbox
        const checkbox = tagsOptions.querySelector(`input[value="${tagToRemove}"]`);
        if (checkbox) checkbox.checked = false;
        
        updateSelectedTagsDisplay();
        updateTagsHiddenInput();
      });
    });
  }

  function getTagLabel(value) {
    const labels = {
      'relaxante': 'Relaxante',
      'aventura': 'Aventura',
      'acao': 'Ação',
      'cultural': 'Cultural',
      'gastronomia': 'Gastronomia',
      'natureza': 'Natureza',
      'esportes': 'Esportes',
      'praia': 'Praia',
      'montanha': 'Montanha',
      'cidade': 'Cidade',
      'romantico': 'Romântico',
      'familia': 'Família'
    };
    return labels[value] || value;
  }

  function updateTagsHiddenInput() {
    tagsHiddenInput.value = JSON.stringify(selectedTagsList);
  }

  // Sistema de busca no mapa
  const mapSearch = document.getElementById('mapSearch');
  const searchLocationBtn = document.getElementById('searchLocationBtn');

  searchLocationBtn.addEventListener('click', async () => {
    const query = mapSearch.value.trim();
    if (!query) return;

    try {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
      const response = await fetch(url, { 
        headers: { 'User-Agent': 'JSG/1.0' } 
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.length > 0) {
          const result = data[0];
          const lat = parseFloat(result.lat);
          const lng = parseFloat(result.lon);
          
          // Centralizar mapa na localização encontrada
          map.setView([lat, lng], 13);
          
          // Limpar marcadores anteriores se existirem
          map.eachLayer(function(layer) {
            if (layer instanceof L.Marker) {
              map.removeLayer(layer);
            }
          });
        } else {
          alert('Localização não encontrada');
        }
      }
    } catch (error) {
      console.error('Erro na busca:', error);
      alert('Erro ao buscar localização');
    }
  });

  // Permitir busca com Enter
  mapSearch.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      searchLocationBtn.click();
    }
  });

  // Clique no mapa adiciona waypoints
  map.on("click", (e) => {
    if (waypoints.length >= 2) {
      waypoints = []; // reseta se já tiver 2 pontos
    }
    waypoints.push(L.latLng(e.latlng.lat, e.latlng.lng));

    if (routingControl) {
      map.removeControl(routingControl);
    }

    if (waypoints.length === 2) {
      routingControl = L.Routing.control({
        waypoints: waypoints,
        lineOptions: { styles: [{ color: 'blue', opacity: 0.7, weight: 5 }] },
        routeWhileDragging: true,
        draggableWaypoints: true,
        addWaypoints: false
      }).addTo(map);

      saveRoute();
    }
  });

  async function getAddress(lat, lng) {
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
    const resp = await fetch(url, { headers: { 'User-Agent': 'JSG/1.0' } });
    if (!resp.ok) return `${lat}, ${lng}`;
    const data = await resp.json();
    return data.display_name || `${lat}, ${lng}`;
  }


  async function saveRoute() {
    if (waypoints.length < 2) return;

    const startAddr = await getAddress(waypoints[0].lat, waypoints[0].lng);
    const endAddr   = await getAddress(waypoints[1].lat, waypoints[1].lng);

    const routeData = {
      display_start: startAddr,
      start: { latitude: waypoints[0].lat, longitude: waypoints[0].lng },
      display_end: endAddr,
      end: { latitude: waypoints[1].lat, longitude: waypoints[1].lng }
    };

    routeInput.value = JSON.stringify(routeData);
    console.log('Rota salva:', routeData);
  }

  // Submit do form
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    // Validar se a rota foi definida
    if (!routeInput.value || routeInput.value.trim() === '') {
      alertDiv.innerHTML = `<div style="color:red">Por favor, selecione uma rota no mapa clicando em dois pontos</div>`;
      return;
    }

    const data = {
      title: form.title.value,
      desc: form.desc.value,
      price: form.price.value,
      numSlots: form.numSlots.value,
      exit_date: form.exit_date.value,
      return_date: form.return_date.value,
      type: form.type.value,
      tags: selectedTagsList,
      image_urls: form.image_urls.value
        .split("\n")
        .map(u => u.trim())
        .filter(u => u),
      route: routeInput.value ? JSON.parse(routeInput.value) : null
    };

    console.log('Dados do formulário:', data);
    console.log('Rota input value:', routeInput.value);

    try {
      const resp = await fetch("/new_event", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const text = await resp.text();
      let result;
      try { result = JSON.parse(text); } catch (_) { result = null; console.log("Resposta bruta:", text); }

      if (resp.ok && result && result.success) {
        alertDiv.innerHTML = `<div style="color:green">${result.message}</div>`;
        form.reset();
        routeInput.value = "";
        waypoints = [];
        if (routingControl) {
          map.removeControl(routingControl);
          routingControl = null;
        }
      } else {
        const msg = (result && result.message) ? result.message : `Erro: ${resp.status}`;
        alertDiv.innerHTML = `<div style="color:red">${msg}</div>`;
      }
    } catch (err) {
      console.error(err);
      alertDiv.innerHTML = `<div style="color:red">Erro na requisição</div>`;
    }
  });
});
</script>

<style>
/* Estilos para o sistema de tags */
.tags-container {
  position: relative;
  margin-top: 0.5rem;
}

.tags-selector {
  position: relative;
  width: 100%;
}

.tags-dropdown-btn {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid #ddd !important;
  border-radius: 8px;
  background: #ffffff !important;
  color: #333333 !important;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 1rem;
  transition: border-color 0.3s ease;
  min-height: 48px;
}

/* Modo escuro */
[data-theme="dark"] .tags-dropdown-btn {
  background: #2d2d2d !important;
  color: #ffffff !important;
  border-color: #555555 !important;
}

.tags-dropdown-btn:hover {
  border-color: var(--primary);
}

.tags-dropdown-btn svg {
  transition: transform 0.3s ease;
}

.tags-dropdown-btn.active svg {
  transform: rotate(180deg);
}

.tags-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: #ffffff !important;
  border: 2px solid #ddd !important;
  border-radius: 8px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
  z-index: 1000;
  display: none;
  max-height: 300px;
  overflow: hidden;
  margin-top: 4px;
}

/* Modo escuro */
[data-theme="dark"] .tags-dropdown {
  background: #2d2d2d !important;
  border-color: #555555 !important;
}

.tags-dropdown.active {
  display: block;
}

.tags-search {
  padding: 0.75rem;
  border-bottom: 1px solid var(--border);
}

.tags-search input {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid #ddd !important;
  border-radius: 6px;
  background: #f8f9fa !important;
  color: #333333 !important;
  font-size: 0.875rem;
}

/* Modo escuro */
[data-theme="dark"] .tags-search input {
  background: #404040 !important;
  color: #ffffff !important;
  border-color: #555555 !important;
}

.tags-search input:focus {
  outline: none;
  border-color: var(--primary);
}

.tags-options {
  max-height: 200px;
  overflow-y: auto;
  padding: 0.5rem;
}

.tag-option {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem;
  cursor: pointer;
  border-radius: 6px;
  transition: background-color 0.2s ease;
}

.tag-option:hover {
  background: var(--bg-hover);
}

.tag-option input[type="checkbox"] {
  margin: 0;
  width: 16px;
  height: 16px;
  accent-color: var(--primary);
}

.tag-label {
  font-size: 0.875rem;
  color: var(--text-primary);
  user-select: none;
}

.selected-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
  min-height: 2rem;
  padding: 0.5rem;
  background: #f8f9fa !important;
  border-radius: 6px;
  border: 1px solid #ddd !important;
}

/* Modo escuro */
[data-theme="dark"] .selected-tags {
  background: #404040 !important;
  border-color: #555555 !important;
}

.selected-tag {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  background: var(--primary);
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.875rem;
}

.remove-tag {
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  padding: 0.25rem;
  border-radius: 4px;
  font-size: 1rem;
  line-height: 1;
}

.remove-tag:hover {
  background: rgba(255, 255, 255, 0.2);
}

/* Estilos para a barra de pesquisa do mapa */
.map-search-container {
  position: relative;
}

.map-search-bar {
  display: flex;
  align-items: center;
  background: var(--background-secondary);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 0.5rem;
  margin-bottom: 0.5rem;
  gap: 0.5rem;
}

.map-search-bar .search-icon {
  color: var(--text-secondary);
  flex-shrink: 0;
}

.map-search-bar input {
  flex: 1;
  border: none;
  background: transparent;
  color: var(--text-primary);
  font-size: 0.875rem;
  outline: none;
}

.map-search-bar input::placeholder {
  color: var(--text-secondary);
}

.map-search-bar button {
  background: var(--primary);
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.875rem;
  transition: background-color 0.3s ease;
}

.map-search-bar button:hover {
  background: var(--primary-hover);
}

/* Responsivo */
@media (max-width: 768px) {
  .tags-checkboxes {
    grid-template-columns: 1fr;
  }
  
  .selected-tags {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .map-search-bar {
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .map-search-bar button {
    width: 100%;
  }
}
</style>

{% endblock %}
