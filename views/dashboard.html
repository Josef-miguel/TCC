{% extends "base.html" %}

{% block content %}
<div class="container layout with-sidebar">
  <aside class="sidebar" id="appSidebar" aria-label="Menu lateral">
    <div class="sidebar-header">
      <span class="sidebar-title">Menu</span>
    </div>
    <nav class="sidebar-nav">
      <a class="sidebar-link" href="{{ url_for('agenda') }}">ğŸ“… <span>Agenda</span></a>
      <a class="sidebar-link" href="{{ url_for('my_chats') }}">ğŸ’¬ <span>Meus Chats</span></a>
    </nav>
  </aside>

  <section class="content-with-sidebar">

  <h1 class="mb-3">Todos os Eventos</h1>
  <ul class="events-list">
    {% for event in events %}
      <li class="event-item card">
        <div class="event-header">
          <h2 class="event-title">{{ event.title }}</h2>
          <form action="{{url_for('chat_individual')}}"></form>
        </div>

        <div class="event-images">
          {% for image in event.images %}
            <img src="{{ image }}" alt="Imagem do evento" style="height: 120px; object-fit:cover; border-radius:8px; width:100%; max-width: 200px;">
          {% endfor %}
        </div>

        <p class="clamp-3">{{ event.desc }}</p>
        <div class="event-meta">
          <span>SaÃ­da: {{ event.exit_date }}</span>
          <span>Retorno: {{ event.return_date }}</span>
          <span>PreÃ§o: R$ {{ event.price }}</span>
          <span>Vagas: {{ event.numSlots }}</span>
        </div>

        <div class="map map-embed"
             id="map-{{ loop.index }}"
             data-route='{{ event.route | default({}) | tojson | safe }}'>
        </div>

        {% for events in user.joinedEvents %}
          {% if events == event.id %}
          <p class="mt-2" style="color:green; font-weight:bold;">VocÃª jÃ¡ estÃ¡ participando desta viagem!</p>
          <form action="{{url_for('chat_group')}}" method="post" class="mt-1">
            <input type="hidden" name="org_uid" value="{{ event.id }}">
            <button class="btn btn-secondary">Falar com o grupo</button>
          </form>
          {% endif %}
        {% endfor %}

        <form action="{{url_for('joinEvent')}}" method="post" class="event-actions mt-2">
          <button class="btn">Participar da viagem</button>
        </form>


      </li>
    {% endfor %}
  </ul>

  <a class="btn btn-outline mt-3" href="{{ url_for('new_event') }}">Criar post</a>

 
  </section>
 </div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // seleciona todas as divs de mapas
  const mapDivs = document.querySelectorAll('.map');

  mapDivs.forEach(div => {
    
    let route;
    try {
      route = JSON.parse(div.dataset.route);
    } catch (e) {
      console.warn("Route invÃ¡lida:", div.id, div.dataset.route);
      return; // pula se nÃ£o for vÃ¡lido
    }

    if (!route || !route.start || !route.end) {
      console.warn("Evento sem rota vÃ¡lida:", div.id);
      return;
    }

    const centerLat = (route.start.latitude + route.end.latitude) / 2;
    const centerLng = (route.start.longitude + route.end.longitude) / 2;

    const map = L.map(div.id).setView([centerLat, centerLng], 8);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
    }).addTo(map);

    // Marcadores
    L.marker([route.start.latitude, route.start.longitude])
      .addTo(map)
      .bindPopup(route.display_start || "SaÃ­da");

    L.marker([route.end.latitude, route.end.longitude])
      .addTo(map)
      .bindPopup(route.display_end || "Chegada");

    // Linha da rota
    L.Routing.control({
      waypoints: [
        L.latLng(route.start.latitude, route.start.longitude),
        L.latLng(route.end.latitude, route.end.longitude)
      ],
      lineOptions: { styles: [{ color: 'blue', opacity: 0.7, weight: 4 }] },
      addWaypoints: false,
      draggableWaypoints: false,
      routeWhileDragging: false,
      fitSelectedRoutes: true,
      showAlternatives: false
    })
    .on('routesfound', e => console.log("Rota encontrada:", e.routes))
    .on('routingerror', e => console.error("Erro no roteamento:", e))
    .addTo(map);

    // forÃ§a o redimensionamento
    setTimeout(() => map.invalidateSize(), 500);
  });
});
</script>
{% endblock %}
