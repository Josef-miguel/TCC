{% extends "base.html" %}

{% block content %}
<a href="{{url_for('perfil')}}">perfil</a>
<h1>Todos os Eventos</h1>
<ul style="list-style:none; padding:0;">
  {% for event in events %}
    <li style="border: black 1px solid; padding: 12px; margin-bottom:16px;">
      <h2>{{ event.title }}</h2>

      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        {% for image in event.images %}
          <img src="{{ image }}" style="height: 120px; object-fit:cover; border-radius:8px;">
        {% endfor %}
      </div>

      <p>{{ event.desc }}</p>
      <p>Saída: {{ event.exit_date }}</p>
      <p>Retorno: {{ event.return_date }}</p>
      <p>Preço: R$ {{ event.price }}</p>
      <p>Vagas: {{ event.numSlots }}</p>

      
      <div class="map"
           id="map-{{ loop.index }}"
           data-route="{{ event.route | tojson | safe }}"
           style="height:300px; width:100%; border-radius:12px; margin-top:8px; border: 1px solid red;">
      </div>
      <pre>{{ event.route | tojson }}</pre>

    </li>

  {% endfor %}
</ul>

<a href="{{ url_for('new_event') }}">Criar post</a>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // seleciona todas as divs de mapas
  const mapDivs = document.querySelectorAll('.map');

mapDivs.forEach((div, idx) => {
  const route = JSON.parse(div.dataset.route || 'null');
  if (!route || !route.start || !route.end) return;

  const centerLat = (route.start.latitude + route.end.latitude) / 2;
  const centerLng = (route.start.longitude + route.end.longitude) / 2;

  // Usa o id da div
  const map = L.map(div.id).setView([centerLat, centerLng], 8);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
  }).addTo(map);

  setTimeout(() => {
    map.invalidateSize();
  }, 200);


  // Marcadores
  L.marker([route.start.latitude, route.start.longitude]).addTo(map).bindPopup(route.display_start || "Saída");
  L.marker([route.end.latitude, route.end.longitude]).addTo(map).bindPopup(route.display_end || "Chegada");

  // Rota
  L.Routing.control({
    waypoints: [
      L.latLng(route.start.latitude, route.start.longitude),
      L.latLng(route.end.latitude, route.end.longitude)
    ],
    lineOptions: { styles: [{ color: 'blue', opacity: 0.7, weight: 4 }] },
    addWaypoints: false,
    draggableWaypoints: false,
    routeWhileDragging: false,
    fitSelectedRoutes: true,
    showAlternatives: false
  }).addTo(map);
});

});
</script>
{% endblock %}
