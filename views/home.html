{% extends "base.html" %}

{% block content %}
<div class="container layout with-sidebar">
  <section class="content-with-sidebar">
    <!-- Header com ícones de navegação -->
    <div class="home-header">
      <div class="nav-icons">
        <!-- <button class="nav-icon"><ion-icon name="search"></ion-icon></button>
        <button class="nav-icon"><ion-icon name="location"></ion-icon></button>
        <button class="nav-icon"><ion-icon name="bookmark"></ion-icon></button> -->
      </div>
    </div>

    <h1 class="mb-3">Discover</h1>
    
    {% for event in events %}
    <div class="simple-post clickable-post" data-event-id="{{ event.id }}" data-event-url="{{ url_for('event_detail', event_id=event.id) }}" style="margin-top: 5vh; margin-bottom: 5vh;">
        <!-- Header com Organizador e Rating -->
        <div class="post-header">
          <div class="organizer-section">
            <div class="organizer-avatar">
              {% if event.organizer and event.organizer.profile_picture %}
                <img src="{{ event.organizer.profile_picture }}" alt="Avatar">
              {% else %}
                <div class="avatar-placeholder">
                  {% if event.organizer and event.organizer.name %}
                    {{ event.organizer.name[0].upper() }}
                  {% else %}
                    O
                  {% endif %}
                </div>
              {% endif %}
            </div>
            <div class="organizer-info">
              <h3 class="organizer-name">
                {% if event.organizer and event.organizer.name %}
                  {{ event.organizer.name }}
                {% else %}
                  Organizador
                {% endif %}
              </h3>
              <span class="organizer-role">Organizador</span>
            </div>
          </div>
          <div class="rating-section">
            <div class="fire-rating" id="fire-rating-{{ event.id }}">
              <ion-icon name="{% if event.favoriteCount and event.favoriteCount > 0 %}flame{% else %}flame-outline{% endif %}" class="fire-icon"></ion-icon>
              <span class="rating-count" id="rating-count-{{ event.id }}">{{ event.favoriteCount or 0 }}</span>
            </div>
          </div>
        </div>

        <!-- Título -->
        <div class="post-title-section clickable-element">
          <h2 class="post-title">
            {% if event.title %}
              {{ event.title }}
            {% else %}
              Viagem sem título
            {% endif %}
          </h2>
        </div>

        <!-- Imagem -->
        <div class="post-image clickable-element">
          {% if event.images %}
            <img src="{{ event.images[0] }}" alt="Imagem da viagem">
          {% else %}
            <div class="default-image">
              <ion-icon name="camera-outline"></ion-icon>
              <span>Sem imagem</span>
            </div>
          {% endif %}
        </div>

        <!-- Informações condensadas -->
        <div class="trip-info-condensed">
          <div class="info-row">
            <div class="info-item">
              <ion-icon name="calendar-outline"></ion-icon>
              <div class="info-text">
                <span class="info-label">Saída</span>
                <span class="info-value">
                  {% if event.exit_date %}
                    {{ event.exit_date.strftime('%d/%m/%Y') }}
                  {% else %}
                    Não definida
                  {% endif %}
                </span>
              </div>
            </div>
            <div class="info-item">
              <ion-icon name="return-up-back-outline"></ion-icon>
              <div class="info-text">
                <span class="info-label">Retorno</span>
                <span class="info-value">
                  {% if event.return_date %}
                    {{ event.return_date.strftime('%d/%m/%Y') }}
                  {% else %}
                    Não definida
                  {% endif %}
                </span>
              </div>
            </div>
          </div>
          
          <div class="info-row">
            <div class="info-item">
              <ion-icon name="cash-outline"></ion-icon>
              <div class="info-text">
                <span class="info-label">Custo</span>
                <span class="info-value">
                  {% if event.price %}
                    R$ {{ event.price }}
                  {% else %}
                    Não informado
                  {% endif %}
                </span>
              </div>
            </div>
            <div class="info-item">
              <ion-icon name="people-outline"></ion-icon>
              <div class="info-text">
                <span class="info-label">Vagas</span>
                <span class="info-value">
                  {% if event.numSlots %}
                    {{ event.numSlots }} disponíveis
                  {% else %}
                    Não informadas
                  {% endif %}
                </span>
              </div>
            </div>
          </div>
          
          <!-- Botão de expandir informações -->
          <div class="expand-info-section">
            <button class="expand-info-btn" data-event-id="{{ event.id }}">
              <span>View More</span>
              <ion-icon name="chevron-forward-outline"></ion-icon>
            </button>
          </div>
        </div>

        <!-- Informações expandidas (inicialmente ocultas) -->
        <div class="card-info-expanded" id="expanded-info-{{ event.id }}" style="display: none;">
          <div class="expanded-content">
            <!-- Descrição -->
            {% if event.desc %}
            <div class="description-section">
              <h4>Descrição</h4>
              <p>{{ event.desc }}</p>
            </div>
            {% endif %}
            
            <!-- Tags -->
            {% if event.tags %}
            <div class="tags-section">
              <h4>Tags</h4>
              <div class="tags-container">
                {% for tag in event.tags %}
                  <span class="tag">#{{ tag }}</span>
                {% endfor %}
              </div>
            </div>
            {% endif %}
            
            <!-- Mapa -->
            {% if event.route %}
            <div class="map-section">
              <h4>Rota da Viagem</h4>
              <div class="map-container">
                <div class="map map-embed"
                     id="map-{{ loop.index }}"
                     data-route='{{ event.route | default({}) | tojson | safe }}'>
                </div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Botões de Ação -->
        <div class="post-actions">
          <button class="action-btn favorite-btn" data-event-id="{{ event.id }}" id="favorite-btn-{{ event.id }}">
            <ion-icon name="heart-outline" id="heart-icon-{{ event.id }}"></ion-icon>
            <span id="favorite-text-{{ event.id }}"></span>
          </button>
          <button class="action-btn comment-toggle" data-event-id="{{ event.id }}">
            <ion-icon name="chatbubble-outline"></ion-icon>
            <!-- <span>Comentar</span> -->
            <span class="comment-count" id="comment-count-{{ event.id }}">(0)</span>
          </button>
          <button class="action-btn share-btn">
            <ion-icon name="share-outline"></ion-icon>
            <!-- <span>Compartilhar</span> -->
          </button>
        </div>

        <!-- Seção de Comentários -->
        <div class="comments-section" id="comments-section-{{ event.id }}" style="display: none;">
          <div class="comments-container">
            <div class="comments-list" id="comments-list-{{ event.id }}">
              <!-- Comentários serão carregados aqui -->
            </div>
            <div class="comment-form">
              <textarea placeholder="Escreva seu comentário..." id="comment-text-{{ event.id }}"></textarea>
              <button class="btn btn-primary submit-comment-btn" data-event-id="{{ event.id }}">Comentar</button>
            </div>
          </div>
        </div>

        <!-- Status de participação -->
        {% if user %}
          {% for events in user.joinedEvents %}
            {% if events == event.id %}
            <div class="participation-status">
              <p class="status-message">Você já está participando desta viagem!</p>
              <form action="{{url_for('chat_group')}}" method="post">
                <input type="hidden" name="org_uid" value="{{ event.id }}">
                <button class="btn btn-secondary">Falar com o grupo</button>
              </form>
            </div>
            {% endif %}
          {% endfor %}
        {% endif %}

        <!-- Formulário de participação -->
        {% if user %}
        <form action="{{url_for('joinEvent')}}" method="post" class="join-form">
          <button class="btn btn-primary">Participar da viagem</button>
          <input type="hidden" name="event_id" value="{{ event.id }}">
        </form>
        {% else %}
        <div class="login-prompt">
          <p>Para participar desta viagem, você precisa estar logado.</p>
          <a href="{{ url_for('login') }}" class="btn btn-primary">Fazer Login</a>
        </div>
        {% endif %}
      </div>
      {% endfor %}
  </section>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  
  // ==================== SISTEMA DE EXPANSÃO DE INFORMAÇÕES ====================
  
  document.querySelectorAll('.expand-info-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const eventId = btn.dataset.eventId;
      const expandedInfo = document.getElementById(`expanded-info-${eventId}`);
      const icons = btn.querySelectorAll('ion-icon');
      
      if (expandedInfo.style.display === 'none' || expandedInfo.style.display === '') {
        expandedInfo.style.display = 'block';
        expandedInfo.style.maxHeight = '0px';
        expandedInfo.style.opacity = '0';
        
        // Animar expansão
        setTimeout(() => {
          expandedInfo.style.maxHeight = expandedInfo.scrollHeight + 'px';
          expandedInfo.style.opacity = '1';
          // Alterar ícone para seta para baixo quando expandido
          const chevronIcon = btn.querySelector('ion-icon');
          if (chevronIcon) {
            chevronIcon.name = 'chevron-down-outline';
          }
        }, 10);
      } else {
        // Animar contração
        expandedInfo.style.maxHeight = '0px';
        expandedInfo.style.opacity = '0';
        // Alterar ícone para seta para frente quando contraído
        const chevronIcon = btn.querySelector('ion-icon');
        if (chevronIcon) {
          chevronIcon.name = 'chevron-forward-outline';
        }
        
        setTimeout(() => {
          expandedInfo.style.display = 'none';
        }, 300);
      }
    });
  });
  
  // ==================== SISTEMA DE COMENTÁRIOS ====================
  
  // Estado global dos comentários
  const commentsState = {};
  
  // Função para inicializar comentários
  function initializeComments() {
    document.querySelectorAll('.comment-toggle').forEach(btn => {
      const eventId = btn.dataset.eventId;
      
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleComments(eventId);
      });
      
      loadCommentsCount(eventId);
      commentsState[eventId] = {
        page: 1,
        hasMore: true,
        loading: false
      };
    });
  }
  
  // Função para alternar seção de comentários
  function toggleComments(eventId) {
    const section = document.getElementById(`comments-section-${eventId}`);
    if (section) {
      if (section.style.display === 'none' || section.style.display === '') {
        section.style.display = 'block';
        section.style.maxHeight = '0px';
        section.style.opacity = '0';
        
        // Animar expansão
        setTimeout(() => {
          section.style.maxHeight = section.scrollHeight + 'px';
          section.style.opacity = '1';
        }, 10);
        
        // Carregar comentários se ainda não foram carregados
        loadComments(eventId);
      } else {
        // Animar contração
        section.style.maxHeight = '0px';
        section.style.opacity = '0';
        
        setTimeout(() => {
          section.style.display = 'none';
        }, 300);
      }
    }
  }
  
  // Função para carregar contagem de comentários
  async function loadCommentsCount(eventId) {
    try {
      const response = await fetch(`/api/comments/${eventId}/count`);
      const data = await response.json();
      
      if (data.success) {
        const countElement = document.getElementById(`comment-count-${eventId}`);
        if (countElement) {
          countElement.textContent = data.count;
        }
      }
    } catch (error) {
      console.error('Erro ao carregar contagem de comentários:', error);
    }
  }
  
  // Função para carregar comentários
  async function loadComments(eventId, page = 1, append = false) {
    try {
      const response = await fetch(`/api/comments/${eventId}?page=${page}&limit=5`);
      const data = await response.json();
      
      if (data.success) {
        const commentsList = document.getElementById(`comments-list-${eventId}`);
        if (commentsList) {
          if (!append) {
            commentsList.innerHTML = '';
          }
          
          data.comments.forEach(comment => {
            const commentElement = document.createElement('div');
            commentElement.className = 'comment-item';
            
            // Formatar data corretamente
            let formattedDate = 'Data inválida';
            if (comment.data_criacao_formatted) {
              formattedDate = comment.data_criacao_formatted;
            } else if (comment.data_criacao) {
              try {
                const date = comment.data_criacao.toDate ? comment.data_criacao.toDate() : new Date(comment.data_criacao);
                formattedDate = date.toLocaleDateString('pt-BR', {
                  day: '2-digit',
                  month: '2-digit',
                  year: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                });
              } catch (e) {
                console.error('Erro ao formatar data:', e);
                formattedDate = 'Data inválida';
              }
            }
            
            commentElement.innerHTML = `
              <div class="comment-header">
                <strong>${comment.author_name || 'Usuário'}</strong>
                <span class="comment-date">${formattedDate}</span>
              </div>
              <div class="comment-content">${comment.texto || comment.content || 'Comentário sem conteúdo'}</div>
            `;
            commentsList.appendChild(commentElement);
          });
          
          // Adicionar botão "Carregar mais" se houver mais comentários
          if (data.has_more && !append) {
            const loadMoreBtn = document.createElement('button');
            loadMoreBtn.className = 'btn btn-secondary load-more-comments';
            loadMoreBtn.textContent = 'Carregar mais comentários';
            loadMoreBtn.dataset.eventId = eventId;
            loadMoreBtn.dataset.page = page + 1;
            loadMoreBtn.style.marginTop = '1rem';
            loadMoreBtn.style.width = '100%';
            
            loadMoreBtn.addEventListener('click', () => {
              loadComments(eventId, page + 1, true);
              loadMoreBtn.remove();
            });
            
            commentsList.appendChild(loadMoreBtn);
          }
        }
      }
    } catch (error) {
      console.error('Erro ao carregar comentários:', error);
    }
  }
  
  // Função para submeter comentário
  async function submitComment(eventId) {
    const textarea = document.getElementById(`comment-text-${eventId}`);
    const content = textarea.value.trim();
    
    if (!content) return;
    
    try {
      const response = await fetch(`/api/comments`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          event_id: eventId,
          texto: content,
          nota: 5 // Nota padrão
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        textarea.value = '';
        loadComments(eventId);
        loadCommentsCount(eventId);
      } else {
        console.error('Erro ao criar comentário:', data.message);
        alert('Erro ao criar comentário: ' + (data.message || 'Erro desconhecido'));
      }
    } catch (error) {
      console.error('Erro ao submeter comentário:', error);
      alert('Erro ao submeter comentário. Tente novamente.');
    }
  }
  
  // Inicializar sistema de comentários
  initializeComments();
  
  // Adicionar event listeners para botões de submeter comentário
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('submit-comment-btn')) {
      e.stopPropagation();
      const eventId = e.target.dataset.eventId;
      submitComment(eventId);
    }
  });
  
  // ==================== SISTEMA DE REDIRECIONAMENTO ====================
  
  // Adicionar event listeners para elementos clicáveis
  document.querySelectorAll('.clickable-post, .clickable-element').forEach(element => {
    element.addEventListener('click', (e) => {
      // Evitar redirecionamento se clicou em botões ou elementos interativos
      if (e.target.closest('button') || e.target.closest('form') || e.target.closest('input') || e.target.closest('textarea') || e.target.closest('.map') || e.target.closest('.map-container') || e.target.closest('.leaflet-container')) {
        return;
      }
      
      const post = e.target.closest('.simple-post');
      if (post) {
        const eventUrl = post.dataset.eventUrl;
        if (eventUrl) {
          window.location.href = eventUrl;
        }
      }
    });
    
    // Adicionar cursor pointer para indicar que é clicável
    element.style.cursor = 'pointer';
  });
  
  // ==================== SISTEMA DE FAVORITOS ====================
  
  const favoritesState = {};
  
  function initializeFavorites() {
    document.querySelectorAll('.favorite-btn').forEach(btn => {
      const eventId = btn.dataset.eventId;
      
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleFavorite(eventId);
      });
      
      loadFavoriteStatus(eventId);
      favoritesState[eventId] = {
        is_favorited: false,
        loading: false
      };
    });
  }
  
  async function loadFavoriteStatus(eventId) {
    try {
      const response = await fetch(`/api/favorites/${eventId}/status`);
      const data = await response.json();
      
      if (data.success) {
        updateFavoriteUI(eventId, data.is_favorited);
        favoritesState[eventId].is_favorited = data.is_favorited;
      }
    } catch (error) {
      console.error('Erro ao carregar status do favorito:', error);
    }
  }
  
  async function toggleFavorite(eventId) {
    if (favoritesState[eventId].loading) return;
    
    favoritesState[eventId].loading = true;
    
    const btn = document.getElementById(`favorite-btn-${eventId}`);
    const icon = document.getElementById(`heart-icon-${eventId}`);
    const text = document.getElementById(`favorite-text-${eventId}`);
    
    btn.disabled = true;
    
    try {
      const response = await fetch(`/api/favorites/${eventId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      });
      
      const data = await response.json();
      
      if (data.success) {
        favoritesState[eventId].is_favorited = data.is_favorited;
        updateFavoriteUI(eventId, data.is_favorited);
      }
    } catch (error) {
      console.error('Erro ao alterar favorito:', error);
    } finally {
      btn.disabled = false;
      favoritesState[eventId].loading = false;
    }
  }
  
  function updateFavoriteUI(eventId, isFavorited) {
    const icon = document.getElementById(`heart-icon-${eventId}`);
    const text = document.getElementById(`favorite-text-${eventId}`);
    const btn = document.getElementById(`favorite-btn-${eventId}`);
    const fireRating = document.getElementById(`fire-rating-${eventId}`);
    const fireIcon = fireRating.querySelector('.fire-icon');
    const ratingCount = document.getElementById(`rating-count-${eventId}`);
    
    if (isFavorited) {
      icon.name = 'heart';
      // text.textContent = 'Favoritado';
      btn.classList.add('favorited');
      
      // Atualizar fire-rating para vermelho
      fireRating.classList.add('favorited');
      fireIcon.name = 'flame';
      
      // Atualizar contador de favoritos
      const currentCount = parseInt(ratingCount.textContent) || 0;
      ratingCount.textContent = currentCount + 1;
    } else {
      icon.name = 'heart-outline';
      // text.textContent = 'Favoritar';
      btn.classList.remove('favorited');
      
      // Remover classe favorited do fire-rating
      fireRating.classList.remove('favorited');
      fireIcon.name = 'flame-outline';
      
      // Atualizar contador de favoritos
      const currentCount = parseInt(ratingCount.textContent) || 0;
      ratingCount.textContent = Math.max(0, currentCount - 1);
    }
  }
  
  // Inicializar sistema de favoritos
  initializeFavorites();
  
  // Tornar fire-rating clicável
  document.querySelectorAll('.fire-rating').forEach(fireRating => {
    fireRating.addEventListener('click', (e) => {
      e.stopPropagation();
      const eventId = fireRating.id.replace('fire-rating-', '');
      toggleFavorite(eventId);
    });
  });
  
  // ==================== MAPAS ====================
  
  // seleciona todas as divs de mapas
  const mapDivs = document.querySelectorAll('.map');

  mapDivs.forEach(div => {
    
    let route;
    try {
      route = JSON.parse(div.dataset.route);
    } catch (e) {
      console.warn("Route inválida:", div.id, div.dataset.route);
      return; // pula se não for válido
    }

    if (!route || !route.start || !route.end) {
      console.warn("Evento sem rota válida:", div.id);
      return;
    }

    // Calcular centro e zoom para focar no trajeto completo
    const startLat = route.start.latitude;
    const startLng = route.start.longitude;
    const endLat = route.end.latitude;
    const endLng = route.end.longitude;
    
    // Calcular o centro entre os dois pontos
    const centerLat = (startLat + endLat) / 2;
    const centerLng = (startLng + endLng) / 2;
    
    // Calcular distância entre os pontos
    const latDiff = Math.abs(startLat - endLat);
    const lngDiff = Math.abs(startLng - endLng);
    const maxDiff = Math.max(latDiff, lngDiff);
    
    // Definir zoom baseado na distância (zoom mais baixo para evitar bugs nos tiles)
    let zoomLevel;
    if (maxDiff > 1.0) {
      zoomLevel = 4;  // Para viagens muito longas
    } else if (maxDiff > 0.5) {
      zoomLevel = 5;  // Para viagens longas
    } else if (maxDiff > 0.1) {
      zoomLevel = 6;  // Para viagens médias
    } else {
      zoomLevel = 7;  // Para viagens curtas
    }

    const map = L.map(div.id, {
      zoomControl: true,
      dragging: true,
      touchZoom: true,
      doubleClickZoom: true,
      scrollWheelZoom: true,
      boxZoom: true,
      keyboard: true,
      preferCanvas: false,
      renderer: L.svg()
    });
    
    // Adicionar tiles primeiro
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
      maxZoom: 8,  // Zoom máximo baixo para evitar bugs nos tiles
      subdomains: ['a', 'b', 'c'],
      errorTileUrl: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'
    }).addTo(map);
    
    // Definir a visualização inicial com centro e zoom calculados
    map.setView([centerLat, centerLng], zoomLevel);

    // Marcadores
    L.marker([startLat, startLng])
      .addTo(map)
      .bindPopup(route.display_start || "Saída");

    L.marker([endLat, endLng])
      .addTo(map)
      .bindPopup(route.display_end || "Chegada");

    // Linha da rota simples (sem roteamento automático para evitar problemas de zoom)
    const routeLine = L.polyline([
      [startLat, startLng],
      [endLat, endLng]
    ], {
      color: 'blue',
      opacity: 0.7,
      weight: 4,
      dashArray: '10, 10'  // Linha tracejada para indicar que é uma rota aproximada
    }).addTo(map);

    // força o redimensionamento e renderização completa
    setTimeout(() => {
      map.invalidateSize();
      // Garantir que os pontos estejam visíveis
      map.setView([centerLat, centerLng], zoomLevel);
    }, 500);
    
    // Redimensionar novamente após um tempo maior para garantir renderização completa
    setTimeout(() => {
      map.invalidateSize();
    }, 1000);
  });
});
</script>
{% endblock %}
