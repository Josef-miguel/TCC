{% extends "base.html" %}

{% block content %}
<div class="container layout with-sidebar">
  <section class="content-with-sidebar">
    <!-- Header com ícones de navegação -->
    <div class="home-header">
      <div class="nav-icons">
        <!-- <button class="nav-icon"><ion-icon name="search"></ion-icon></button>
        <button class="nav-icon"><ion-icon name="location"></ion-icon></button>
        <button class="nav-icon"><ion-icon name="bookmark"></ion-icon></button> -->
      </div>
    </div>

    <h1 class="mb-3">Discover</h1>
    
    {% for event in events %}
    <div class="simple-post" data-event-id="{{ event.id }}" data-event-url="{{ url_for('event_detail', event_id=event.id) }}" style="margin-top: 5vh; margin-bottom: 5vh;">
        <!-- Header com Organizador e Rating -->
        <div class="post-header">
          <div class="organizer-section">
            <div class="organizer-avatar">
              {% if event.organizer and event.organizer.profile_picture %}
                <img src="{{ event.organizer.profile_picture }}" alt="Avatar">
              {% else %}
                <div class="avatar-placeholder">
                  {% if event.organizer and event.organizer.name %}
                    {{ event.organizer.name[0].upper() }}
                  {% else %}
                    O
                  {% endif %}
                </div>
              {% endif %}
            </div>
            <div class="organizer-info">
              <h3 class="organizer-name">
                {% if event.organizer and event.organizer.name %}
                  {{ event.organizer.name }}
                {% else %}
                  Organizador
                {% endif %}
              </h3>
              <span class="organizer-role">Organizador</span>
            </div>
          </div>
          <div class="rating-section">
            <div class="stars" id="stars-{{ event.id }}">
              <ion-icon name="star-outline" id="star1-{{ event.id }}"></ion-icon>
              <ion-icon name="star-outline" id="star2-{{ event.id }}"></ion-icon>
              <ion-icon name="star-outline" id="star3-{{ event.id }}"></ion-icon>
              <ion-icon name="star-outline" id="star4-{{ event.id }}"></ion-icon>
              <ion-icon name="star-outline" id="star5-{{ event.id }}"></ion-icon>
            </div>
            <span class="rating-value" id="rating-value-{{ event.id }}">0.0</span>
            <span class="rating-count" id="rating-count-{{ event.id }}">(0)</span>
          </div>
        </div>

        <!-- Título -->
        <div class="post-title-section">
          <h2 class="post-title">
            {% if event.title %}
              {{ event.title }}
            {% else %}
              Viagem sem título
            {% endif %}
          </h2>
        </div>

        <!-- Imagem -->
        <div class="post-image">
          {% if event.images %}
            <img src="{{ event.images[0] }}" alt="Imagem da viagem">
          {% else %}
            <div class="default-image">
              <ion-icon name="camera-outline"></ion-icon>
              <span>Sem imagem</span>
            </div>
          {% endif %}
        </div>

        <!-- Informações condensadas -->
        <div class="trip-info-condensed">
          <div class="info-row">
            <div class="info-item">
              <ion-icon name="calendar-outline"></ion-icon>
              <div class="info-text">
                <span class="info-label">Saída</span>
                <span class="info-value">
                  {% if event.exit_date %}
                    {{ event.exit_date.strftime('%d/%m/%Y') }}
                  {% else %}
                    Não definida
                  {% endif %}
                </span>
              </div>
            </div>
            <div class="info-item">
              <ion-icon name="return-up-back-outline"></ion-icon>
              <div class="info-text">
                <span class="info-label">Retorno</span>
                <span class="info-value">
                  {% if event.return_date %}
                    {{ event.return_date.strftime('%d/%m/%Y') }}
                  {% else %}
                    Não definida
                  {% endif %}
                </span>
              </div>
            </div>
          </div>
          
          <div class="info-row">
            <div class="info-item">
              <ion-icon name="cash-outline"></ion-icon>
              <div class="info-text">
                <span class="info-label">Custo</span>
                <span class="info-value">
                  {% if event.price %}
                    R$ {{ event.price }}
                  {% else %}
                    Não informado
                  {% endif %}
                </span>
              </div>
            </div>
            <div class="info-item">
              <ion-icon name="people-outline"></ion-icon>
              <div class="info-text">
                <span class="info-label">Vagas</span>
                <span class="info-value">
                  {% if event.numSlots %}
                    {{ event.numSlots }} disponíveis
                  {% else %}
                    Não informadas
                  {% endif %}
                </span>
              </div>
            </div>
          </div>
          
          <!-- Botão de expandir informações -->
          <div class="expand-info-section">
            <button class="expand-info-btn" data-event-id="{{ event.id }}">
              <ion-icon name="chevron-down-outline"></ion-icon>
              <ion-icon name="chevron-down-outline"></ion-icon>
            </button>
          </div>
        </div>

        <!-- Informações expandidas (inicialmente ocultas) -->
        <div class="card-info-expanded" id="expanded-info-{{ event.id }}" style="display: none;">
          <div class="expanded-content">
            <!-- Descrição -->
            {% if event.desc %}
            <div class="description-section">
              <h4>Descrição</h4>
              <p>{{ event.desc }}</p>
            </div>
            {% endif %}
            
            <!-- Tags -->
            {% if event.tags %}
            <div class="tags-section">
              <h4>Tags</h4>
              <div class="tags-container">
                {% for tag in event.tags %}
                  <span class="tag">#{{ tag }}</span>
                {% endfor %}
              </div>
            </div>
            {% endif %}
            
            <!-- Mapa -->
            {% if event.route %}
            <div class="map-section">
              <h4>Rota da Viagem</h4>
              <div class="map-container">
                <div class="map map-embed"
                     id="map-{{ loop.index }}"
                     data-route='{{ event.route | default({}) | tojson | safe }}'>
                </div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Botões de Ação -->
        <div class="post-actions">
          <button class="action-btn favorite-btn" data-event-id="{{ event.id }}" id="favorite-btn-{{ event.id }}">
            <ion-icon name="heart-outline" id="heart-icon-{{ event.id }}"></ion-icon>
            <span id="favorite-text-{{ event.id }}"></span>
          </button>
          <button class="action-btn comment-toggle" data-event-id="{{ event.id }}">
            <ion-icon name="chatbubble-outline"></ion-icon>
            <span>Comentar</span>
            <span class="comment-count" id="comment-count-{{ event.id }}">(0)</span>
          </button>
          <button class="action-btn share-btn">
            <ion-icon name="share-outline"></ion-icon>
            <span>Compartilhar</span>
          </button>
        </div>

        <!-- Status de participação -->
        {% if user %}
          {% for events in user.joinedEvents %}
            {% if events == event.id %}
            <div class="participation-status">
              <p class="status-message">Você já está participando desta viagem!</p>
              <form action="{{url_for('chat_group')}}" method="post">
                <input type="hidden" name="org_uid" value="{{ event.id }}">
                <button class="btn btn-secondary">Falar com o grupo</button>
              </form>
            </div>
            {% endif %}
          {% endfor %}
        {% endif %}

        <!-- Formulário de participação -->
        {% if user %}
        <form action="{{url_for('joinEvent')}}" method="post" class="join-form">
          <button class="btn btn-primary">Participar da viagem</button>
          <input type="hidden" name="event_id" value="{{ event.id }}">
        </form>
        {% else %}
        <div class="login-prompt">
          <p>Para participar desta viagem, você precisa estar logado.</p>
          <a href="{{ url_for('login') }}" class="btn btn-primary">Fazer Login</a>
        </div>
        {% endif %}
      </div>
      {% endfor %}
  </section>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  
  // ==================== SISTEMA DE EXPANSÃO DE INFORMAÇÕES ====================
  
  document.querySelectorAll('.expand-info-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const eventId = btn.dataset.eventId;
      const expandedInfo = document.getElementById(`expanded-info-${eventId}`);
      const icons = btn.querySelectorAll('ion-icon');
      
      if (expandedInfo.style.display === 'none' || expandedInfo.style.display === '') {
        expandedInfo.style.display = 'block';
        expandedInfo.style.maxHeight = '0px';
        expandedInfo.style.opacity = '0';
        
        // Animar expansão
        setTimeout(() => {
          expandedInfo.style.maxHeight = expandedInfo.scrollHeight + 'px';
          expandedInfo.style.opacity = '1';
          icons.forEach(icon => icon.name = 'chevron-up-outline');
        }, 10);
      } else {
        // Animar contração
        expandedInfo.style.maxHeight = '0px';
        expandedInfo.style.opacity = '0';
        icons.forEach(icon => icon.name = 'chevron-down-outline');
        
        setTimeout(() => {
          expandedInfo.style.display = 'none';
        }, 300);
      }
    });
  });
  
  // ==================== SISTEMA DE COMENTÁRIOS ====================
  
  // Estado global dos comentários
  const commentsState = {};
  
  // Função para inicializar comentários
  function initializeComments() {
    document.querySelectorAll('.comment-toggle').forEach(btn => {
      const eventId = btn.dataset.eventId;
      
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleComments(eventId);
      });
      
      loadCommentsCount(eventId);
      commentsState[eventId] = {
        page: 1,
        hasMore: true,
        loading: false
      };
    });
  }
  
  // Função para alternar seção de comentários
  function toggleComments(eventId) {
    const section = document.getElementById(`comments-section-${eventId}`);
    if (section) {
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }
  }
  
  // Função para carregar contagem de comentários
  async function loadCommentsCount(eventId) {
    try {
      const response = await fetch(`/api/comments/${eventId}/count`);
      const data = await response.json();
      
      if (data.success) {
        const countElement = document.getElementById(`comment-count-${eventId}`);
        if (countElement) {
          countElement.textContent = data.count;
        }
      }
    } catch (error) {
      console.error('Erro ao carregar contagem de comentários:', error);
    }
  }
  
  // Inicializar sistema de comentários
  initializeComments();
  
  // ==================== SISTEMA DE FAVORITOS ====================
  
  const favoritesState = {};
  
  function initializeFavorites() {
    document.querySelectorAll('.favorite-btn').forEach(btn => {
      const eventId = btn.dataset.eventId;
      
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleFavorite(eventId);
      });
      
      loadFavoriteStatus(eventId);
      favoritesState[eventId] = {
        is_favorited: false,
        loading: false
      };
    });
  }
  
  async function loadFavoriteStatus(eventId) {
    try {
      const response = await fetch(`/api/favorites/${eventId}/status`);
      const data = await response.json();
      
      if (data.success) {
        updateFavoriteUI(eventId, data.is_favorited);
        favoritesState[eventId].is_favorited = data.is_favorited;
      }
    } catch (error) {
      console.error('Erro ao carregar status do favorito:', error);
    }
  }
  
  async function toggleFavorite(eventId) {
    if (favoritesState[eventId].loading) return;
    
    favoritesState[eventId].loading = true;
    
    const btn = document.getElementById(`favorite-btn-${eventId}`);
    const icon = document.getElementById(`heart-icon-${eventId}`);
    const text = document.getElementById(`favorite-text-${eventId}`);
    
    btn.disabled = true;
    
    try {
      const response = await fetch(`/api/favorites/${eventId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      });
      
      const data = await response.json();
      
      if (data.success) {
        favoritesState[eventId].is_favorited = data.is_favorited;
        updateFavoriteUI(eventId, data.is_favorited);
      }
    } catch (error) {
      console.error('Erro ao alterar favorito:', error);
    } finally {
      btn.disabled = false;
      favoritesState[eventId].loading = false;
    }
  }
  
  function updateFavoriteUI(eventId, isFavorited) {
    const icon = document.getElementById(`heart-icon-${eventId}`);
    const text = document.getElementById(`favorite-text-${eventId}`);
    const btn = document.getElementById(`favorite-btn-${eventId}`);
    
    if (isFavorited) {
      icon.name = 'heart';
      text.textContent = 'Favoritado';
      btn.classList.add('favorited');
    } else {
      icon.name = 'heart-outline';
      text.textContent = 'Favoritar';
      btn.classList.remove('favorited');
    }
  }
  
  // Inicializar sistema de favoritos
  initializeFavorites();
  
  // ==================== SISTEMA DE AVALIAÇÕES ====================
  
  function initializeRatings() {
    document.querySelectorAll('.discover-card').forEach(card => {
      const eventId = card.dataset.eventId;
      if (eventId) {
        loadEventRating(eventId);
      }
    });
  }
  
  async function loadEventRating(eventId) {
    try {
      const response = await fetch(`/api/events/${eventId}/rating`);
      const data = await response.json();
      
      if (data.success) {
        updateRatingUI(eventId, data);
      }
    } catch (error) {
      console.error('Erro ao carregar avaliação do evento:', error);
    }
  }
  
  function updateRatingUI(eventId, ratingData) {
    const starsContainer = document.getElementById(`stars-${eventId}`);
    const ratingValue = document.getElementById(`rating-value-${eventId}`);
    
    if (!starsContainer || !ratingValue) return;
    
    ratingValue.textContent = ratingData.average_rating.toFixed(1);
    
    const stars = starsContainer.querySelectorAll('ion-icon');
    stars.forEach((star, index) => {
      const starValue = ratingData.stars[index];
      
      if (starValue === 1) {
        star.name = 'star';
      } else if (starValue === 0.5) {
        star.name = 'star-half';
      } else {
        star.name = 'star-outline';
      }
    });
  }
  
  // Inicializar sistema de avaliações
  initializeRatings();
  
  // ==================== MAPAS ====================
  
  // seleciona todas as divs de mapas
  const mapDivs = document.querySelectorAll('.map');

  mapDivs.forEach(div => {
    
    let route;
    try {
      route = JSON.parse(div.dataset.route);
    } catch (e) {
      console.warn("Route inválida:", div.id, div.dataset.route);
      return; // pula se não for válido
    }

    if (!route || !route.start || !route.end) {
      console.warn("Evento sem rota válida:", div.id);
      return;
    }

    const centerLat = (route.start.latitude + route.end.latitude) / 2;
    const centerLng = (route.start.longitude + route.end.longitude) / 2;

    const map = L.map(div.id).setView([centerLat, centerLng], 8);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
    }).addTo(map);

    // Marcadores
    L.marker([route.start.latitude, route.start.longitude])
      .addTo(map)
      .bindPopup(route.display_start || "Saída");

    L.marker([route.end.latitude, route.end.longitude])
      .addTo(map)
      .bindPopup(route.display_end || "Chegada");

    // Linha da rota
    L.Routing.control({
      waypoints: [
        L.latLng(route.start.latitude, route.start.longitude),
        L.latLng(route.end.latitude, route.end.longitude)
      ],
      lineOptions: { styles: [{ color: 'blue', opacity: 0.7, weight: 4 }] },
      addWaypoints: false,
      draggableWaypoints: false,
      routeWhileDragging: false,
      fitSelectedRoutes: true,
      showAlternatives: false
    })
    .on('routesfound', e => console.log("Rota encontrada:", e.routes))
    .on('routingerror', e => console.error("Erro no roteamento:", e))
    .addTo(map);

    // força o redimensionamento
    setTimeout(() => map.invalidateSize(), 500);
  });
});
</script>
{% endblock %}
