{% extends "base.html" %}

{% block content %}
<div class="container layout with-sidebar">
  <section class="content-with-sidebar">
    <!-- Header com ícones de navegação -->
    <div class="home-header">
      <div class="nav-icons">
        <button class="nav-icon"><ion-icon name="search"></ion-icon></button>
        <button class="nav-icon"><ion-icon name="location"></ion-icon></button>
        <button class="nav-icon"><ion-icon name="bookmark"></ion-icon></button>
      </div>
    </div>

    <h1 class="mb-3">Discover</h1>
    
    {% for event in events %}
    <div class="post-card">
      <!-- Imagem de fundo do post -->
      <div class="post-background">
        {% if event.images %}
          <img src="{{ event.images[0] }}" alt="Imagem do evento" class="background-image">
        {% else %}
          <div class="default-background"></div>
        {% endif %}
        
        <!-- Overlay escuro -->
        <div class="post-overlay"></div>
        
        <!-- Conteúdo sobreposto -->
        <div class="post-content">
          <!-- Header/Categoria -->
          <div class="post-header">
            <span class="post-category">Discover</span>
            <span class="post-type">Gastronômico</span>
          </div>

          <!-- Destino com Rating -->
          <div class="post-destination">
            <h2 class="post-title">{{ event.title }}</h2>
            <div class="post-rating">
              <span class="stars">
                <ion-icon name="star"></ion-icon>
                <ion-icon name="star"></ion-icon>
                <ion-icon name="star"></ion-icon>
                <ion-icon name="star"></ion-icon>
                <ion-icon name="star"></ion-icon>
              </span>
              <span class="rating-value">4.9</span>
            </div>
          </div>

          <!-- Resumo da Viagem -->
          <div class="post-summary">
            <div class="summary-item">
              <span class="label">Duração:</span>
              <span class="value">{{ event.exit_date }} - {{ event.return_date }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Custo:</span>
              <span class="value">R$ {{ event.price }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Vagas:</span>
              <span class="value">{{ event.numSlots }}</span>
            </div>
          </div>

          <!-- Perfil do Autor -->
          <div class="post-author">
            <span class="author-handle">@{{ event.organizer.username if event.organizer else 'organizador' }}</span>
            <span class="author-role">Viajante</span>
          </div>

          <!-- Descrição -->
          <div class="post-description">
            <p class="description-text">{{ event.desc }}</p>
            <div class="post-hashtags">
              <span class="hashtag">#viagem</span>
              <span class="hashtag">#aventura</span>
              <span class="hashtag">#descobrir</span>
            </div>
          </div>

          <!-- Tags de Conteúdo -->
          <div class="post-content-tags">
            <span class="content-tag">#gastronomia</span>
            <span class="content-tag">#cultura</span>
            <span class="content-tag">#cidade</span>
          </div>

          <!-- Métricas de Engajamento -->
          <div class="post-metrics">
            <div class="metric">
              <span class="metric-icon"><ion-icon name="heart"></ion-icon></span>
              <span class="metric-value">9.9K</span>
            </div>
            <div class="metric">
              <span class="metric-icon"><ion-icon name="save"></ion-icon></span>
              <span class="metric-value">2.3K</span>
            </div>
            <div class="metric">
              <span class="metric-icon"><ion-icon name="share"></ion-icon></span>
              <span class="metric-value">567</span>
            </div>
          </div>

          <!-- Botões de Ação -->
          <div class="post-actions">
            <button class="action-btn primary">Rota</button>
            <button class="action-btn secondary">Planejar</button>
            <button class="action-btn icon"><ion-icon name="location"></ion-icon></button>
          </div>
        </div>
      </div>

      <!-- Mapa -->
      <div class="map-container">
        <div class="map map-embed"
             id="map-{{ loop.index }}"
             data-route='{{ event.route | default({}) | tojson | safe }}'>
        </div>
      </div>

      <!-- Status de participação -->
      {% for events in user.joinedEvents %}
        {% if events == event.id %}
        <div class="participation-status">
          <p class="status-message">Você já está participando desta viagem!</p>
          <form action="{{url_for('chat_group')}}" method="post">
            <input type="hidden" name="org_uid" value="{{ event.id }}">
            <button class="btn btn-secondary">Falar com o grupo</button>
          </form>
        </div>
        {% endif %}
      {% endfor %}

      <!-- Formulário de participação -->
      <form action="{{url_for('joinEvent')}}" method="post" class="join-form">
        <button class="btn btn-primary">Participar da viagem</button>
        <input type="hidden" name="event_id" value="{{ event.id }}">
      </form>
    </div>
    {% endfor %}

    <a class="btn btn-outline mt-3" href="{{ url_for('new_event') }}">Criar post</a>
  </section>
 </div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // seleciona todas as divs de mapas
  const mapDivs = document.querySelectorAll('.map');

  mapDivs.forEach(div => {
    
    let route;
    try {
      route = JSON.parse(div.dataset.route);
    } catch (e) {
      console.warn("Route inválida:", div.id, div.dataset.route);
      return; // pula se não for válido
    }

    if (!route || !route.start || !route.end) {
      console.warn("Evento sem rota válida:", div.id);
      return;
    }

    const centerLat = (route.start.latitude + route.end.latitude) / 2;
    const centerLng = (route.start.longitude + route.end.longitude) / 2;

    const map = L.map(div.id).setView([centerLat, centerLng], 8);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
    }).addTo(map);

    // Marcadores
    L.marker([route.start.latitude, route.start.longitude])
      .addTo(map)
      .bindPopup(route.display_start || "Saída");

    L.marker([route.end.latitude, route.end.longitude])
      .addTo(map)
      .bindPopup(route.display_end || "Chegada");

    // Linha da rota
    L.Routing.control({
      waypoints: [
        L.latLng(route.start.latitude, route.start.longitude),
        L.latLng(route.end.latitude, route.end.longitude)
      ],
      lineOptions: { styles: [{ color: 'blue', opacity: 0.7, weight: 4 }] },
      addWaypoints: false,
      draggableWaypoints: false,
      routeWhileDragging: false,
      fitSelectedRoutes: true,
      showAlternatives: false
    })
    .on('routesfound', e => console.log("Rota encontrada:", e.routes))
    .on('routingerror', e => console.error("Erro no roteamento:", e))
    .addTo(map);

    // força o redimensionamento
    setTimeout(() => map.invalidateSize(), 500);
  });
});
</script>
{% endblock %}
