{% extends 'base.html' %}

{% block content %}
<div class="chat-interface">
    <!-- Header do Chat -->
    <div class="chat-header-bar">
        <button class="back-btn" onclick="history.back()">
            <ion-icon name="arrow-back-outline"></ion-icon>
        </button>
        <div class="chat-user-info">
            <div class="chat-user-avatar">
                <ion-icon name="person"></ion-icon>
            </div>
            <div class="chat-user-details">
                <h3 class="chat-user-name">Conversa Individual</h3>
                <span class="chat-user-status">Online</span>
            </div>
        </div>
        <div class="chat-actions">
            <button class="chat-action-btn">
                <ion-icon name="call-outline"></ion-icon>
            </button>
            <button class="chat-action-btn">
                <ion-icon name="videocam-outline"></ion-icon>
            </button>
            <button class="chat-action-btn">
                <ion-icon name="ellipsis-vertical-outline"></ion-icon>
            </button>
        </div>
    </div>

    <!-- Área de Mensagens -->
    <div class="chat-messages-container">
        <div id="messages" class="chat-messages"></div>
        
        <!-- Indicador de digitação -->
        <div class="typing-indicator" id="typing-indicator" style="display: none;">
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <span class="typing-text">digitando...</span>
        </div>
    </div>

    <!-- Input de Mensagem -->
    <div class="chat-input-container">
        <div class="chat-input-wrapper">
            <button class="attachment-btn">
                <ion-icon name="attach-outline"></ion-icon>
            </button>
            <div class="message-input-wrapper">
                <input type="text" id="message-input" placeholder="Digite sua mensagem..." autocomplete="off">
                <button class="emoji-btn">
                    <ion-icon name="happy-outline"></ion-icon>
                </button>
            </div>
            <button id="send-btn" class="send-btn">
                <ion-icon name="send"></ion-icon>
            </button>
        </div>
    </div>
</div>

<script>
const chatUid = "{{ chat_uid }}";
const userUid = "{{ g.user['uid'] }}";
const messagesDiv = document.getElementById('messages');

window.addEventListener("DOMContentLoaded", () => {
  fetchMessages(); // já chama 1 vez
  setInterval(fetchMessages, 3000);
});

async function fetchMessages() {
    if (!chatUid) return;

    let url = `/get_messages?chat_uid=${chatUid}&limit=50`;

    const res = await fetch(url);
    const data = await res.json();
    if (data.success) {
        messagesDiv.innerHTML = '';
        data.messages.forEach(m => {
            const msgEl = createMessageElement(m);
            messagesDiv.appendChild(msgEl);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    } else {
        console.error("Erro ao buscar mensagens:", data.error || data.message);
    }
}

function createMessageElement(message) {
    const msgEl = document.createElement('div');
    const isOwnMessage = message.uid_sender === userUid;
    
    let ts;
    if (message.timestamp && message.timestamp._seconds) {
        ts = new Date(message.timestamp._seconds * 1000);
    } else if (message.timestamp) {
        ts = new Date(message.timestamp);
    } else {
        ts = new Date();
    }

    const senderName = message.name || "Usuário";
    const timeString = ts.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    const isEdited = message.edited || false;
    const isOldMessage = (Date.now() - ts.getTime()) > 3600000; // 1 hora em ms
    
    msgEl.className = `message ${isOwnMessage ? 'own-message' : 'other-message'}`;
    msgEl.setAttribute('data-message-id', message.id);
    
    if (isOwnMessage) {
        const editDeleteButtons = !isOldMessage ? `
            <div class="message-actions">
                <button class="edit-btn" onclick="editMessage('${message.id}', '${message.text.replace(/'/g, "\\'")}')">
                    <ion-icon name="create-outline"></ion-icon>
                </button>
                <button class="delete-btn" onclick="deleteMessage('${message.id}')">
                    <ion-icon name="trash-outline"></ion-icon>
                </button>
            </div>
        ` : '';
        
        msgEl.innerHTML = `
            <div class="message-content">
                <div class="message-bubble">
                    <p class="message-text">${message.text}</p>
                    <div class="message-footer">
                        <span class="message-time">${timeString}</span>
                        ${isEdited ? '<span class="edited-indicator">(editado)</span>' : ''}
                    </div>
                </div>
                ${editDeleteButtons}
            </div>
        `;
    } else {
        msgEl.innerHTML = `
            <div class="message-content">
                <div class="message-avatar">
                    <ion-icon name="person"></ion-icon>
                </div>
                <div class="message-bubble">
                    <div class="message-header">
                        <span class="sender-name">${senderName}</span>
                    </div>
                    <p class="message-text">${message.text}</p>
                    <div class="message-footer">
                        <span class="message-time">${timeString}</span>
                        ${isEdited ? '<span class="edited-indicator">(editado)</span>' : ''}
                    </div>
                </div>
            </div>
        `;
    }
    
    return msgEl;
}

// Enviar mensagem: envia chat_uid em vez de org_uid
document.getElementById('send-btn').addEventListener('click', async () => {
    const text = document.getElementById('message-input').value;
    if (!text) return;

    const res = await fetch('/send_message', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({text, chat_uid: chatUid})
    });

    const j = await res.json();
    if (!j.success) console.error("Erro ao enviar:", j.message);
    document.getElementById('message-input').value = '';
    fetchMessages();
});

// Função para editar mensagem
async function editMessage(messageId, currentText) {
    const newText = prompt('Editar mensagem:', currentText);
    if (newText === null || newText.trim() === currentText.trim()) return;
    
    if (newText.trim().length === 0) {
        alert('A mensagem não pode estar vazia');
        return;
    }
    
    if (newText.length > 1000) {
        alert('A mensagem é muito longa (máximo 1000 caracteres)');
        return;
    }
    
    try {
        const requestData = {
            text: newText.trim(),
            chat_type: 'individual',
            chat_id: chatUid
        };
        
        console.log('Enviando dados para edição:', requestData);
        console.log('Message ID:', messageId);
        
        const res = await fetch(`/api/messages/${messageId}/edit`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestData)
        });
        
        console.log('Resposta do servidor:', res.status, res.statusText);
        
        const result = await res.json();
        console.log('Resultado da edição:', result);
        
        if (result.success) {
            fetchMessages(); // Recarregar mensagens
        } else {
            alert(result.message || 'Erro ao editar mensagem');
        }
    } catch (error) {
        console.error('Erro ao editar mensagem:', error);
        alert('Erro ao editar mensagem');
    }
}

// Função para excluir mensagem
async function deleteMessage(messageId) {
    if (!confirm('Tem certeza que deseja excluir esta mensagem?')) return;
    
    try {
        const requestData = {
            chat_type: 'individual',
            chat_id: chatUid
        };
        
        console.log('Enviando dados para exclusão:', requestData);
        console.log('Message ID:', messageId);
        
        const res = await fetch(`/api/messages/${messageId}/delete`, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestData)
        });
        
        console.log('Resposta do servidor:', res.status, res.statusText);
        
        const result = await res.json();
        console.log('Resultado da exclusão:', result);
        
        if (result.success) {
            fetchMessages(); // Recarregar mensagens
        } else {
            alert(result.message || 'Erro ao excluir mensagem');
        }
    } catch (error) {
        console.error('Erro ao excluir mensagem:', error);
        alert('Erro ao excluir mensagem');
    }
}

</script>

{% endblock %}
