{% extends 'base.html' %}

{% block content %}
<pre>{{chat_uid}}}</pre>

<div id="chat-container">
  <div id="messages" style="height:400px; overflow-y:scroll; border:1px solid #ccc; padding:10px;"></div>

  <input type="text" id="message-input" placeholder="Digite sua mensagem">
  <button id="send-btn">Enviar</button>
</div>

<script>
const chatUid = "{{ chat_uid }}";
const userUid = "{{ g.user['uid'] }}";
const messagesDiv = document.getElementById('messages');

window.addEventListener("DOMContentLoaded", () => {
  fetchMessages(); // já chama 1 vez
  setInterval(fetchMessages, 3000);
});

async function fetchMessages() {
    if (!chatUid) return;

    let url = `/get_messages?chat_uid=${chatUid}&limit=50`;

    const res = await fetch(url);
    const data = await res.json();
    if (data.success) {
        messagesDiv.innerHTML = '';
        data.messages.forEach(m => {
            const msgEl = document.createElement('div');

            let ts;
            if (m.timestamp && m.timestamp._seconds) {
                ts = new Date(m.timestamp._seconds * 1000);
            } else if (m.timestamp) {
                ts = new Date(m.timestamp); // fallback se for string ISO
            } else {
                ts = new Date();
            }

            const sender = m.uid_sender === userUid ? "Você" : (m.name || "Outro");
            msgEl.textContent = `${sender}: ${m.text} (${ts.toLocaleString()})`;
            messagesDiv.appendChild(msgEl);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    } else {
        console.error("Erro ao buscar mensagens:", data.error || data.message);
    }
}

// Enviar mensagem: envia chat_uid em vez de org_uid
document.getElementById('send-btn').addEventListener('click', async () => {
    const text = document.getElementById('message-input').value;
    if (!text) return;

    const res = await fetch('/send_message', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({text, chat_uid: chatUid})
    });

    const j = await res.json();
    if (!j.success) console.error("Erro ao enviar:", j.message);
    document.getElementById('message-input').value = '';
    fetchMessages();
});

</script>

{% endblock %}
