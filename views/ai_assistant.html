{% extends "base.html" %}

{% block title %}Assistente de Viagens IA - JustSetGo{% endblock %}

{% block head %}
<style>
  .ai-assistant-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }

  .ai-header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    color: white;
  }

  .ai-header h1 {
    margin: 0 0 10px 0;
    font-size: 2.5rem;
    font-weight: 700;
  }

  .ai-header p {
    margin: 0;
    font-size: 1.1rem;
    opacity: 0.9;
  }

  .ai-dashboard {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
  }

  .ai-card {
    background: var(--background-secondary);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .ai-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }

  .ai-card h3 {
    margin: 0 0 15px 0;
    color: var(--text-primary);
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .ai-card h3 ion-icon {
    color: #667eea;
  }

  .suggestion-item {
    background: var(--background-secondary);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    border-left: 4px solid #667eea;
    transition: all 0.3s ease;
  }

  .suggestion-item:hover {
    background: var(--background-hover);
    transform: translateX(5px);
  }

  .suggestion-item h4 {
    margin: 0 0 8px 0;
    color: var(--text-primary);
    font-size: 1rem;
  }

  .suggestion-item p {
    margin: 0 0 10px 0;
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .suggestion-actions {
    display: flex;
    gap: 10px;
  }

  .btn-small {
    padding: 5px 12px;
    font-size: 0.8rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-primary {
    background: #667eea;
    color: white;
  }

  .btn-primary:hover {
    background: #5a6fd8;
  }

  .btn-secondary {
    background: var(--background-secondary);
    color: var(--text-secondary);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover {
    background: var(--background-hover);
  }

  .chat-container {
    grid-column: 1 / -1;
    background: var(--background-secondary);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .chat-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border);
  }

  .chat-header h3 {
    margin: 0;
    color: var(--text-primary);
  }

  .chat-messages {
    height: 400px;
    overflow-y: auto;
    padding: 15px;
    background: var(--background-secondary);
    border-radius: 8px;
    margin-bottom: 15px;
    border: 1px solid var(--border);
  }

  .message {
    margin-bottom: 15px;
    padding: 12px 16px;
    border-radius: 12px;
    max-width: 80%;
    word-wrap: break-word;
  }

  .message.user {
    background: #667eea;
    color: white;
    margin-left: auto;
    text-align: right;
  }

  .message.ai {
    background: var(--background-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border);
  }

  .message-time {
    font-size: 0.7rem;
    opacity: 0.7;
    margin-top: 5px;
  }

  .chat-input-container {
    display: flex;
    gap: 10px;
  }

  .chat-input {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: 25px;
    background: var(--background-secondary);
    color: var(--text-primary);
    font-size: 1rem;
    outline: none;
    transition: border-color 0.3s ease;
  }

  .chat-input:focus {
    border-color: #667eea;
  }

  .chat-send-btn {
    padding: 12px 20px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    transition: background 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .chat-send-btn:hover {
    background: #5a6fd8;
  }

  .chat-send-btn:disabled {
    background: var(--background-secondary);
    color: var(--text-secondary);
    cursor: not-allowed;
  }

  .insight-item {
    background: var(--background-secondary);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    border-left: 4px solid #764ba2;
  }

  .insight-item h4 {
    margin: 0 0 8px 0;
    color: var(--text-primary);
    font-size: 1rem;
  }

  .insight-item p {
    margin: 0;
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .confidence-bar {
    width: 100%;
    height: 4px;
    background: var(--background-secondary);
    border-radius: 2px;
    margin-top: 8px;
    overflow: hidden;
  }

  .confidence-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea, #764ba2);
    border-radius: 2px;
    transition: width 0.3s ease;
  }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
  }

  .empty-state ion-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
  }

  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .typing-indicator {
    display: none;
    padding: 12px 16px;
    background: var(--background-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    margin-bottom: 15px;
    max-width: 80px;
  }

  .typing-dots {
    display: flex;
    gap: 4px;
  }

  .typing-dot {
    width: 8px;
    height: 8px;
    background: var(--text-secondary);
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
  }

  .typing-dot:nth-child(1) { animation-delay: -0.32s; }
  .typing-dot:nth-child(2) { animation-delay: -0.16s; }

  @keyframes typing {
    0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
  }

  @media (max-width: 768px) {
    .ai-dashboard {
      grid-template-columns: 1fr;
    }
    
    .ai-header h1 {
      font-size: 2rem;
    }
    
    .chat-messages {
      height: 300px;
    }
    
    .message {
      max-width: 95%;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="ai-assistant-container">
  <!-- Header -->
  <div class="ai-header">
    <h1><ion-icon name="sparkles"></ion-icon> Assistente de Viagens IA</h1>
    <p>Seu assistente pessoal inteligente para organizar e otimizar suas viagens</p>
  </div>

  <!-- Dashboard -->
  <div class="ai-dashboard">
    <!-- Sugestões -->
    <div class="ai-card">
      <h3><ion-icon name="bulb-outline"></ion-icon> Sugestões Inteligentes</h3>
      <div id="suggestions-container">
        {% if suggestions %}
          {% for suggestion in suggestions %}
          <div class="suggestion-item" data-suggestion-id="{{ suggestion.id }}">
            <h4>{{ suggestion.title }}</h4>
            <p>{{ suggestion.description }}</p>
            <div class="suggestion-actions">
              <button class="btn-small btn-primary" onclick="viewSuggestion('{{ suggestion.id }}')">
                Ver Detalhes
              </button>
              <button class="btn-small btn-secondary" onclick="dismissSuggestion('{{ suggestion.id }}')">
                Dispensar
              </button>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">
            <ion-icon name="bulb-outline"></ion-icon>
            <p>Nenhuma sugestão no momento.<br>Continue explorando para receber recomendações personalizadas!</p>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Insights -->
    <div class="ai-card">
      <h3><ion-icon name="analytics-outline"></ion-icon> Insights de Viagem</h3>
      <div id="insights-container">
        {% if insights %}
          {% for insight in insights %}
          <div class="insight-item">
            <h4>{{ insight.title }}</h4>
            <p>{{ insight.description }}</p>
            <div class="confidence-bar">
              <div class="confidence-fill" style="width: {{ (insight.confidence_score * 100) }}%"></div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">
            <ion-icon name="analytics-outline"></ion-icon>
            <p>Analisando seus padrões de viagem...<br>Insights serão gerados em breve!</p>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Chat com IA -->
    <div class="chat-container">
      <div class="chat-header">
        <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
        <h3>Chat com Assistente IA</h3>
      </div>
      
      <div class="chat-messages" id="chatMessages">
        {% if chat_history %}
          {% for message in chat_history %}
          <div class="message user">
            {{ message.message }}
            <div class="message-time">{{ message.created_at.strftime('%H:%M') }}</div>
          </div>
          <div class="message ai">
            {{ message.response }}
            <div class="message-time">{{ message.created_at.strftime('%H:%M') }}</div>
          </div>
          {% endfor %}
        {% else %}
          <div class="message ai">
            Olá! Sou seu assistente pessoal de viagens. Como posso ajudá-lo hoje? 
            <br><br>
            Posso:
            <br>• Sugerir destinos baseados nos seus favoritos
            <br>• Encontrar as melhores datas para viajar
            <br>• Verificar conflitos na sua agenda
            <br>• Criar lembretes automáticos
            <br>• Gerar resumos das suas viagens
          </div>
        {% endif %}
        
        <div class="typing-indicator" id="typingIndicator">
          <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      </div>
      
      <div class="chat-input-container">
        <input type="text" class="chat-input" id="chatInput" placeholder="Digite sua pergunta sobre viagens..." maxlength="500">
        <button class="chat-send-btn" id="chatSendBtn" onclick="sendMessage()">
          <ion-icon name="send-outline"></ion-icon>
          Enviar
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Chat functionality
  const chatInput = document.getElementById('chatInput');
  const chatSendBtn = document.getElementById('chatSendBtn');
  const chatMessages = document.getElementById('chatMessages');
  const typingIndicator = document.getElementById('typingIndicator');

  // Auto-scroll to bottom
  function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Add message to chat
  function addMessage(message, isUser = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
    
    const time = new Date().toLocaleTimeString('pt-BR', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
    
    messageDiv.innerHTML = `
      ${message}
      <div class="message-time">${time}</div>
    `;
    
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
  }

  // Show typing indicator
  function showTyping() {
    typingIndicator.style.display = 'block';
    scrollToBottom();
  }

  // Hide typing indicator
  function hideTyping() {
    typingIndicator.style.display = 'none';
  }

  // Send message to AI
  async function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;

    // Add user message
    addMessage(message, true);
    chatInput.value = '';
    chatSendBtn.disabled = true;
    showTyping();

    try {
      const response = await fetch('/ai_chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
      });

      const data = await response.json();
      
      hideTyping();
      
      if (data.success) {
        addMessage(data.response);
      } else {
        addMessage('Desculpe, ocorreu um erro ao processar sua mensagem. Tente novamente.');
      }
    } catch (error) {
      hideTyping();
      addMessage('Erro de conexão. Verifique sua internet e tente novamente.');
      console.error('Erro no chat:', error);
    } finally {
      chatSendBtn.disabled = false;
      chatInput.focus();
    }
  }

  // Event listeners
  chatInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  chatSendBtn.addEventListener('click', sendMessage);

  // Suggestion functions
  function viewSuggestion(suggestionId) {
    // TODO: Implementar visualização detalhada da sugestão
    alert('Funcionalidade de visualização detalhada será implementada em breve!');
  }

  async function dismissSuggestion(suggestionId) {
    try {
      const response = await fetch('/ai_dismiss_suggestion', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ suggestion_id: suggestionId })
      });

      const data = await response.json();
      
      if (data.success) {
        // Remove suggestion from UI
        const suggestionElement = document.querySelector(`[data-suggestion-id="${suggestionId}"]`);
        if (suggestionElement) {
          suggestionElement.style.opacity = '0.5';
          suggestionElement.style.transform = 'translateX(-100%)';
          setTimeout(() => {
            suggestionElement.remove();
          }, 300);
        }
      } else {
        alert('Erro ao dispensar sugestão: ' + data.message);
      }
    } catch (error) {
      console.error('Erro ao dispensar sugestão:', error);
      alert('Erro de conexão. Tente novamente.');
    }
  }

  // Auto-refresh suggestions and insights
  async function refreshData() {
    try {
      // Refresh suggestions
      const suggestionsResponse = await fetch('/ai_suggestions?limit=5');
      const suggestionsData = await suggestionsResponse.json();
      
      if (suggestionsData.success) {
        updateSuggestionsUI(suggestionsData.suggestions);
      }

      // Refresh insights
      const insightsResponse = await fetch('/ai_insights?limit=3');
      const insightsData = await insightsResponse.json();
      
      if (insightsData.success) {
        updateInsightsUI(insightsData.insights);
      }
    } catch (error) {
      console.error('Erro ao atualizar dados:', error);
    }
  }

  function updateSuggestionsUI(suggestions) {
    const container = document.getElementById('suggestions-container');
    
    if (suggestions.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <ion-icon name="bulb-outline"></ion-icon>
          <p>Nenhuma sugestão no momento.<br>Continue explorando para receber recomendações personalizadas!</p>
        </div>
      `;
      return;
    }

    container.innerHTML = suggestions.map(suggestion => `
      <div class="suggestion-item" data-suggestion-id="${suggestion.id}">
        <h4>${suggestion.title}</h4>
        <p>${suggestion.description}</p>
        <div class="suggestion-actions">
          <button class="btn-small btn-primary" onclick="viewSuggestion('${suggestion.id}')">
            Ver Detalhes
          </button>
          <button class="btn-small btn-secondary" onclick="dismissSuggestion('${suggestion.id}')">
            Dispensar
          </button>
        </div>
      </div>
    `).join('');
  }

  function updateInsightsUI(insights) {
    const container = document.getElementById('insights-container');
    
    if (insights.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <ion-icon name="analytics-outline"></ion-icon>
          <p>Analisando seus padrões de viagem...<br>Insights serão gerados em breve!</p>
        </div>
      `;
      return;
    }

    container.innerHTML = insights.map(insight => `
      <div class="insight-item">
        <h4>${insight.title}</h4>
        <p>${insight.description}</p>
        <div class="confidence-bar">
          <div class="confidence-fill" style="width: ${insight.confidence_score * 100}%"></div>
        </div>
      </div>
    `).join('');
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    // Focus on chat input
    chatInput.focus();
    
    // Auto-refresh data every 30 seconds
    setInterval(refreshData, 30000);
    
    // Initial scroll to bottom
    scrollToBottom();
  });
</script>
{% endblock %}
